!function(){var a=function(){var a,b,c,d,e,f,g,h,i,j,k,l,m=function(a,b){return function(){return a.apply(b,arguments)}},n={}.hasOwnProperty,o=function(a,b){function c(){this.constructor=a}for(var d in b)n.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a};return j="undefined"!=typeof exports&&null!==exports?new Object:this,j.KiiSocialNetworkName={FACEBOOK:1,TWITTER:2},j.KiiSite={US:"https://api.kii.com/api",JP:"https://api-jp.kii.com/api",CN:"https://api-cn2.kii.com/api",SG:"https://api-sg.kii.com/api"},j.Kii=function(){function a(){}var b,d;return d=null,b=null,a.getBuildNumber=function(){return"1"},a.getSDKVersion=function(){return"2.1.14"},a.getBaseURL=function(){return d._baseURL},a.getAppID=function(){return d._appID},a.getAdditionalHeaders=function(){return b},a.setAdditionalHeaders=function(a){return b=a},a.getAppKey=function(){return d._appKey},a.isLogging=function(){return d._logging},a.setLogging=function(a){return d._logging=a,j.Kii.logger("Setting logging: "+a),j.Kii.logger("Base URL: "+d._baseURL)},a.initializeWithSite=function(a,b,c){return d=new k(a,b,c),j.Kii.logger("Initialized "+a+", "+b+", "+c)},a.initialize=function(a,b){return j.Kii.initializeWithSite(a,b,j.KiiSite.US)},a.logger=function(a){return d._logging?console.log(a):void 0},a.bucketWithName=function(a){return new j.KiiBucket._bucketWithName(a,null)},a.groupWithName=function(a){return new j.Kii.groupWithNameAndMembers(a,null)},a.groupWithNameAndMembers=function(a,b){return new j.KiiGroup.groupWithNameAndMembers(a,b)},a.logOut=function(){return d._currentUser=null,j.KiiSocialConnect.logOutAll()},a.loggedIn=function(){return null!=d._currentUser},a.getCurrentUser=function(){var a;return null!=d._currentUser?(a=new j.KiiUser,a._uuid=d._currentUser._uuid,a._username=d._currentUser._username,a._displayName=d._currentUser._displayName,a._password=d._currentUser._password,a._emailAddress=d._currentUser._emailAddress,a._phoneNumber=d._currentUser._phoneNumber,a._country=d._currentUser._country,a._created=d._currentUser._created,a._modified=d._currentUser._modified,a._emailVerified=d._currentUser._emailVerified,a._phoneVerified=d._currentUser._phoneVerified,a._accessToken=d._currentUser._accessToken,a._customInfo=d._currentUser._customInfo,j.Kii.logger("my instance:"),j.Kii.logger(a),a):null},a.setCurrentUser=function(a){return d._currentUser=new j.KiiUser,d._currentUser._uuid=a._uuid,d._currentUser._username=a._username,d._currentUser._displayName=a._displayName,d._currentUser._password=a._password,d._currentUser._emailAddress=a._emailAddress,d._currentUser._phoneNumber=a._phoneNumber,d._currentUser._country=a._country,d._currentUser._created=a._created,d._currentUser._modified=a._modified,d._currentUser._emailVerified=a._emailVerified,d._currentUser._phoneVerified=a._phoneVerified,d._currentUser._accessToken=a._accessToken,d._currentUser._customInfo=a._customInfo,j.Kii.logger("my instance:"),j.Kii.logger(d._currentUser)},a.authenticateAsAppAdmin=function(a,b,d){var e,f;return f=new c("/oauth2/token",!1),f.setAnonymous(!0),f.setMethod("POST"),f.setData({client_id:a,client_secret:b}),e={success:function(){return function(a){var b,c,e;return e=a.access_token,c=a.id,j.Kii.logger("token: "+e),j.Kii.logger("id: "+c),b=new j.KiiAppAdminContext({token:e,id:c}),null!=d?d.success(b):void 0}}(this),failure:function(){return function(a,b){return j.Kii.logger("error: "+a),j.Kii.logger("statusCode: "+b),null!=d?d.failure(a,b):void 0}}(this)},f.execute(e,!1)},a.authenticateAsAdminWithToken=function(a){return new j.KiiAppAdminContext({token:a})},a._setHttpRequestType=function(a){return j.Kii.logger("Set http request as "+a),d._httpRequestType=a},a._getHttpRequestType=function(){return d._httpRequestType},a._getKiiUtilities=function(){return f},a}(),j._KiiHttpRequestType={jQuery:"jQuery",XMLHttpRequest:"XMLHttpRequest",Titanium:"Titanium"},k=function(){function a(a,b,c){this._appKey=b,this._appID=a,this._baseURL=c}return a.prototype._logging=!1,a.prototype._baseURL=null,a.prototype._currentUser=null,a.prototype._httpRequestType=null,a}(),j.KiiACL=function(){function a(){this._userWithID=m(this._userWithID,this),this._groupWithID=m(this._groupWithID,this),this._getRequest=m(this._getRequest,this),this._saveItr=m(this._saveItr,this),this.save=m(this.save,this),this.removeACLEntry=m(this.removeACLEntry,this),this.putACLEntry=m(this.putACLEntry,this),this.listACLEntries=m(this.listACLEntries,this),this.aclPath=m(this.aclPath,this),this._setParent=m(this._setParent,this),this._entries=[]}var b,d,e;return e=null,b=null,d=null,a.prototype._setParent=function(a){this._parent=a},a.prototype.aclPath=function(){var a,b,c,d,e,f,g;return this._parent instanceof j.KiiObject?(d=this._parent,null!=d.getBucket().getUser()?g=d.getBucket().getUser():null!=d.getBucket().getGroup()&&(c=d.getBucket().getGroup()),b=d.getBucket().getBucketName(),e=d.getUUID()):this._parent instanceof j.KiiBucket?(a=this._parent,null!=a.getUser()?g=a.getUser():null!=a.getGroup()&&(c=a.getGroup()),b=a.getBucketName()):j.Kii.logger("Invalid ACL parent. Must belong to a KiiObject"),f="/",null!=c?f+="groups/"+c.getUUID()+"/":null!=g&&(f+="users/"+g.getUUID()+"/"),f+=null!=e?"buckets/"+b+"/objects/"+e+"/acl":"buckets/"+b+"/acl"},a.prototype.listACLEntries=function(a){var b,c;return e=this,j.Kii.logger("Listing ACL entries"),c=this._getRequest({path:this.aclPath(),withApp:!0}),b={success:function(b){return function(c,d){var f,g,h,i,k,l,m,n;if(300>d&&d>=200){i=[];for(h in c)for(l=c[h],"WRITE_EXISTING_OBJECT"===h?f=j.KiiACLAction.KiiACLObjectActionWrite:"READ_EXISTING_OBJECT"===h?f=j.KiiACLAction.KiiACLObjectActionRead:"QUERY_OBJECTS_IN_BUCKET"===h?f=j.KiiACLAction.KiiACLBucketActionQueryObjects:"CREATE_OBJECTS_IN_BUCKET"===h?f=j.KiiACLAction.KiiACLBucketActionCreateObjects:"DROP_BUCKET_WITH_ALL_CONTENT"===h&&(f=j.KiiACLAction.KiiACLBucketActionDropBucket),m=0,n=l.length;n>m;m++)g=l[m],null!=g.groupID?k=b._groupWithID(g.groupID):null!=g.userID&&(k=b._userWithID(g.userID)),i.push(j.KiiACLEntry.entryWithSubject(k,f));return a.success(e,i)}return a.failure(e,"Unable to retrieve ACL list")}}(this),failure:function(){return function(b){return a.failure(e,b)}}(this)},c.execute(b,!1)},a.prototype.putACLEntry=function(a){return-1===this._entries.indexOf(a)?this._entries.push(a):void 0},a.prototype.removeACLEntry=function(a){var b;return b=this._entries.indexOf(a),b>-1?f.arrayRemove(this._entries,b,b):void 0},a.prototype.save=function(a){return j.Kii.logger("SAving acl"),this._saveItr(0,a)},a.prototype._saveItr=function(a,b){var c,d,e,f,g;return g=this,c=this._entries[a],d=""+this.aclPath()+"/"+c.getActionString()+"/"+c.getEntityString(),j.Kii.logger("Saving single @path: "+d),e=this._getRequest({path:d,withApp:!0}),e.setMethod(c.getGrant()===!0?"PUT":"DELETE"),f=null,e.execute({success:function(c){return function(){return a<c._entries.length-1?c._saveItr(a+1,b):b.success(c)}}(this),failure:function(a){return function(c){return b.failure(a,c)}}(this)},!1)},a.aclWithParent=function(a){var b;return b=new j.KiiACL,b._setParent(a),b},a.prototype._getRequest=function(a){var b,d,e;return b=a.path,e=a.withApp,d=new c(b,e)},a.prototype._groupWithID=function(a){var b;return b=j.KiiGroup._groupWithID(a)},a.prototype._userWithID=function(a){var b;return b=j.KiiUser._userWithID(a)},a}(),j.KiiACLAction={KiiACLBucketActionCreateObjects:0,KiiACLBucketActionQueryObjects:1,KiiACLBucketActionDropBucket:2,KiiACLObjectActionRead:3,KiiACLObjectActionWrite:4},j.KiiACLEntry=function(){function a(){this.getEntityString=m(this.getEntityString,this),this.getActionString=m(this.getActionString,this),this.getGrant=m(this.getGrant,this),this.setGrant=m(this.setGrant,this),this.getSubject=m(this.getSubject,this),this.setSubject=m(this.setSubject,this),this.getAction=m(this.getAction,this),this.setAction=m(this.setAction,this),this._action=-1,this._grant=!0}var b,c,d;return b=null,d=null,c=null,a.prototype.setAction=function(a){if(a>=j.KiiACLAction.KiiACLBucketActionCreateObjects&&a<=j.KiiACLAction.KiiACLObjectActionWrite)return this._action=a;throw new InvalidACLAction},a.prototype.getAction=function(){return this._action},a.prototype.setSubject=function(a){if(a instanceof j.KiiGroup||a instanceof j.KiiUser||a instanceof j.KiiAnyAuthenticatedUser||a instanceof j.KiiAnonymousUser)return this._subject=a;throw new j.InvalidACLSubject},a.prototype.getSubject=function(){return this._subject},a.prototype.setGrant=function(a){if(a===!0||a===!1)return this._grant=a;throw new InvalidACLGrant},a.prototype.getGrant=function(){return this._grant},a.entryWithSubject=function(a,b){var c;return j.Kii.logger("EWS: "+a+", "+b),c=new j.KiiACLEntry,c.setSubject(a),c.setAction(b),c},a.prototype.getActionString=function(){var a;switch(j.Kii.logger("Action: "+this.action),this._action){case j.KiiACLAction.KiiACLBucketActionCreateObjects:a="CREATE_OBJECTS_IN_BUCKET";break;case j.KiiACLAction.KiiACLBucketActionQueryObjects:a="QUERY_OBJECTS_IN_BUCKET";break;case j.KiiACLAction.KiiACLBucketActionDropBucket:a="DROP_BUCKET_WITH_ALL_CONTENT";break;case j.KiiACLAction.KiiACLObjectActionRead:a="READ_EXISTING_OBJECT";break;case j.KiiACLAction.KiiACLObjectActionWrite:a="WRITE_EXISTING_OBJECT";break;default:return a}return a},a.prototype.getEntityString=function(){var a,b;return this._subject instanceof j.KiiGroup?(a=this._subject.getUUID(),b="GroupID"):this._subject instanceof j.KiiUser?(a=this._subject.getUUID(),b="UserID"):this._subject instanceof j.KiiAnyAuthenticatedUser?(b="UserID",a="ANY_AUTHENTICATED_USER"):this._subject instanceof j.KiiAnonymousUser&&(b="UserID",a="ANONYMOUS_USER"),""+b+":"+a},a}(),j.KiiBucket=function(){function a(a,b){this.objectWithJSON=m(this.objectWithJSON,this),this._generatePath=m(this._generatePath,this),this._getRequest=m(this._getRequest,this),this["delete"]=m(this["delete"],this),this.count=m(this.count,this),this.countWithQuery=m(this.countWithQuery,this),this.executeQuery=m(this.executeQuery,this),this.acl=m(this.acl,this),this.createObjectWithType=m(this.createObjectWithType,this),this.createObject=m(this.createObject,this),this._setBucketName=m(this._setBucketName,this),this.getBucketName=m(this.getBucketName,this),this._setGroup=m(this._setGroup,this),this.getGroup=m(this.getGroup,this),this._setUser=m(this._setUser,this),this.getUser=m(this.getUser,this),this._bucketName=a,null!=b&&(b instanceof j.KiiGroup?this._group=b:b instanceof j.KiiUser&&(this._user=b))}var b,d,e,f;return a.prototype._className="KiiBucket",e=null,b=null,f=null,d=null,a.prototype.getUser=function(){return this._user},a.prototype._setUser=function(a){this._user=a},a.prototype.getGroup=function(){return this._group},a.prototype._setGroup=function(a){this._group=a},a.prototype.getBucketName=function(){return this._bucketName},a.prototype._setBucketName=function(a){this._bucketName=a},a.prototype.createObject=function(){return j.KiiObject.objectWithBucket(this,null)},a.prototype.createObjectWithType=function(a){return j.KiiObject.objectWithBucket(this,a)},a.prototype.acl=function(){return j.KiiACL.aclWithParent(this)},a.prototype.executeQuery=function(a,b){var c,d,f,g;return e=this,f=this._generatePath()+"/query",c={},null!=a?c=a._dictValue():c.bucketQuery={clause:j.KiiQuery._emptyDictValue()},g=this._getRequest({path:f,withApp:!0}),g.setMethod("POST"),g.setContentType("application/vnd.kii.QueryRequest+json"),g.setData(c),d={success:function(){return function(c,d){var f,g,h,i,j,k;if(300>d&&d>=200){for(h=[],k=c.results,i=0,j=k.length;j>i;i++)g=k[i],h.push(e.objectWithJSON(g));if(null!=c.nextPaginationKey&&(f=new KiiQuery(a),f.setPaginationKey(c.nextPaginationKey)),null!=b)return b.success(a,h,f)}else if(null!=b)return b.failure(a,"Unable to parse response")}}(this),failure:function(){return function(a){return null!=b?b.failure(e,a):void 0}}(this)},g.execute(d,!1)},a.prototype.countWithQuery=function(a,b){var c,d,f,g;return e=this,f=this._generatePath()+"/query",c={},null!=a?c=a._dictValue():(c.bucketQuery={clause:j.KiiQuery._emptyDictValue()},a=KiiQuery.queryWithClause()),c.bucketQuery.aggregations=[{type:"COUNT",putAggregationInto:"count_field"}],g=this._getRequest({path:f,withApp:!0}),g.setMethod("POST"),g.setContentType("application/vnd.kii.QueryRequest+json"),g.setData(c),d={success:function(){return function(c,d){var f;if(300>d&&d>=200){if(f=c.aggregations.count_field,null!=b)return b.success(e,a,f)}else if(null!=b)return b.failure(e,a,"Unable to parse response")}}(this),failure:function(){return function(a){return null!=b?b.failure(e,a):void 0}}(this)},g.execute(d,!1)},a.prototype.count=function(a){var b;return b=KiiQuery.queryWithClause(),this.countWithQuery(b,a)},a.prototype["delete"]=function(a){var b,c;return e=this,c=this._getRequest({path:this._generatePath(),withApp:!0}),c.setMethod("DELETE"),b={success:function(){return function(){return null!=a?a.success(e):void 0}}(this),failure:function(){return function(b){return null!=a?a.failure(e,b):void 0}}(this)},c.execute(b,!0)},a._bucketWithName=function(a,b){var c;return c=new j.KiiBucket(a,b)},a.prototype._getRequest=function(a){var b,d,e;return b=a.path,e=a.withApp,d=new c(b,e)},a.prototype._generatePath=function(){var a;return a=null!=this._user?"/users/"+this._user.getUUID()+"/buckets/"+this._bucketName:null!=this._group?"/groups/"+this._group.getUUID()+"/buckets/"+this._bucketName:"/buckets/"+this._bucketName},a.prototype.objectWithJSON=function(a){var b;return b=this.createObject(),b._updateWithJSON(a),b},a}(),j.KiiBucketAdmin=function(a){function b(a,c,d){this.acl=m(this.acl,this),this.createObjectWithType=m(this.createObjectWithType,this),this.createObject=m(this.createObject,this),this._getRequest=m(this._getRequest,this),b.__super__.constructor.call(this,a,c),this._adminToken=d}var c;return o(b,a),c=null,b.prototype._getRequest=function(a){var c;return c=b.__super__._getRequest.call(this,a),c.setAdminToken(this._adminToken),c},b.prototype.createObject=function(){return j.KiiObjectAdmin.objectWithBucket(this,null,this._adminToken)},b.prototype.createObjectWithType=function(a){return j.KiiObjectAdmin.objectWithBucket(this,a,this._adminToken)},b.prototype.acl=function(){var a;return a=new j.KiiACLAdmin(this,this._adminToken)},b}(j.KiiBucket),j.KiiGroup=function(){function a(){this._setOwnerFromContext=m(this._setOwnerFromContext,this),this._userWithID=m(this._userWithID,this),this._getRequest=m(this._getRequest,this),this.getOwner=m(this.getOwner,this),this["delete"]=m(this["delete"],this),this.refresh=m(this.refresh,this),this.save=m(this.save,this),this.changeGroupName=m(this.changeGroupName,this),this._saveMembers=m(this._saveMembers,this),this.getMemberList=m(this.getMemberList,this),this._removeMember=m(this._removeMember,this),this._addMember=m(this._addMember,this),this.removeUser=m(this.removeUser,this),this.addUser=m(this.addUser,this),this.bucketWithName=m(this.bucketWithName,this),this.objectURI=m(this.objectURI,this),this._setOwner=m(this._setOwner,this),this.getCachedOwner=m(this.getCachedOwner,this),this._setName=m(this._setName,this),this.getName=m(this.getName,this),this._setUUID=m(this._setUUID,this),this.getUUID=m(this.getUUID,this),this._setAddMembers=m(this._setAddMembers,this),this._getRemoveMembers=m(this._getRemoveMembers,this),this._getAddMembers=m(this._getAddMembers,this),this._addMembers={},this._removeMembers={}}var b,d,e,f,g;return g=null,d=null,e=null,b=null,f=null,a.prototype._getAddMembers=function(){return this._addMembers},a.prototype._getRemoveMembers=function(){return this._removeMembers},a.prototype._setAddMembers=function(a){var b,c,d,e;if(null!=a){for(e=[],c=0,d=a.length;d>c;c++)b=a[c],e.push(this.addUser(b));return e}},a.prototype.getUUID=function(){return this._uuid},a.prototype._setUUID=function(a){this._uuid=a},a.prototype.getName=function(){return this._groupName},a.prototype._setName=function(a){this._groupName=a},a.prototype.getCachedOwner=function(){return this._owner},a.prototype._setOwner=function(a){this._owner=a},a.prototype.objectURI=function(){return null!=this._uuid?"kiicloud://groups/"+this._uuid:null},a.prototype.bucketWithName=function(a){var b;return b=new j.KiiBucket(a,this)},a.prototype.addUser=function(a){var b;return null==a?void j.Kii.logger("Passed member is null"):null==a.getUUID()?void j.Kii.logger("Passed member ID is null"):(b=a.getUUID(),b in this._addMembers||(this._addMembers[b]=a),b in this._removeMembers?delete this._removeMembers[b]:void 0)},a.prototype.removeUser=function(a){var b;return null==a?void j.Kii.logger("Passed member is null"):null==a.getUUID()?void j.Kii.logger("Passed member uuid is null"):(b=a.getUUID(),b in this._removeMembers||(this._removeMembers[b]=a),b in this._addMembers?delete this._addMembers[b]:void 0)},a.prototype._addMember=function(a,b){var c,d;return g=this,j.Kii.logger("Adding member "+a.getUUID()+" to group "+this._groupName),d=this._getRequest({path:"/groups/"+this._uuid+"/members/"+a.getUUID(),withApp:!0}),d.setMethod("PUT"),c={success:function(c){return function(){return delete c._addMembers[a.getUUID()],g._saveMembers(b)}}(this),failure:function(c){return function(d){var e,f,h;return e=function(){var b,c;b=this._addMembers,c=[];for(h in b)a=b[h],c.push(a);return c}.call(c),f=function(){var b,c;b=this._removeMembers,c=[];for(h in b)a=b[h],c.push(a);return c}.call(c),b.failure(g,d,e,f)}}(this)},d.execute(c,!1)},a.prototype._removeMember=function(a,b){var c,d;return g=this,j.Kii.logger("Removing member "+a.getUUID()+" to group "+this._groupName),d=this._getRequest({path:"/groups/"+this._uuid+"/members/"+a.getUUID(),withApp:!0}),d.setMethod("DELETE"),c={success:function(c){return function(){return delete c._getRemoveMembers()[a.getUUID()],g._saveMembers(b)}}(this),failure:function(c){return function(d){var e,f,h;return e=function(){var b,c;b=this._addMembers,c=[];for(h in b)a=b[h],c.push(a);return c}.call(c),f=function(){var b,c;b=this._removeMembers,c=[];for(h in b)a=b[h],c.push(a);return c}.call(c),b.failure(g,d,e,f)}}(this)},d.execute(c,!1)},a.prototype.getMemberList=function(a){var b,c;return g=this,j.Kii.logger("Getting member list for group "+this._groupName),c=this._getRequest({path:"/groups/"+this._uuid+"/members",withApp:!0}),c.setAccept("application/vnd.kii.MembersRetrievalResponse+json"),b={success:function(b){return function(c,d){var e,f,h,i,j;if(300>d&&d>=200){for(f=[],h=c.members,i=0,j=h.length;j>i;i++)e=h[i],f.push(b._userWithID(e.userID));if(null!=a)return a.success(g,f)}else if(null!=a)return a.failure(g,e,"Unable to get member list of group")}}(this),failure:function(){return function(b){return null!=a?a.failure(g,b):void 0}}(this)},c.execute(b,!1)},a.prototype._saveMembers=function(a){var b,c;return g=this,b=Object.keys(this._addMembers),c=Object.keys(this._removeMembers),0===b.length&&0===c.length&&a.success(g),b.length>0?void this._addMember(this._addMembers[b[0]],a):void(c.length>0&&this._removeMember(this._removeMembers[c[0]],a))},a.prototype.changeGroupName=function(a,b){var c,d;return g=this,j.Kii.logger("Saving group: "+this.name),null!=this._uuid?(c=this._getRequest({path:"/groups/"+this._uuid+"/name",withApp:!0}),c.setContentType("text/plain"),c.setMethod("PUT"),c.setData(a),d={success:function(){return function(c,d){if(300>d&&d>=200){if(g._setName(a),null!=b)return b.success(g)}else if(null!=b)return b.failure(g,"Unable to change group name - invalid response")}}(this),failure:function(){return function(a){return null!=b?b.failure(g,a):void 0}}(this)},c.execute(d,!0)):b.failure(g,"Invalid group. Save the group on the server before updating the name.")},a.prototype.save=function(a){var b,c,d;return g=this,j.Kii.logger("Saving group: "+this.name),null==this._uuid?(c=this._getRequest({path:"/groups",withApp:!0}),c.setContentType("application/vnd.kii.GroupCreationRequest+json"),c.setMethod("POST"),b={},null!=this._groupName&&(b.name=this._groupName),this._setOwnerFromContext(b),c.setData(b),d={success:function(){return function(b,c){return 300>c&&c>=200?(g._setUUID(b.groupID),g._saveMembers(a)):void 0}}(this),failure:function(b){return function(c){var d,e,f,h;return null!=a?(d=function(){var a,b;a=this._addMembers,b=[];for(h in a)e=a[h],b.push(e);return b}.call(b),f=function(){var a,b;a=this._removeMembers,b=[];for(h in a)e=a[h],b.push(e);return b}.call(b),a.failure(g,c,d,f)):void 0}}(this)},c.execute(d,!1)):this._saveMembers(a)},a.prototype.refresh=function(a){var b,c;return g=this,j.Kii.logger("Refreshing group: "+this._groupName),c=new this._getRequest({path:"/groups/"+this._uuid,withApp:!0}),c.setAccept("application/vnd.kii.GroupRetrievalResponse+json"),b={success:function(){return function(b){return g=j.KiiGroup._groupWithJSON(b),null!=a?a.success(g):void 0}}(this),failure:function(){return function(b){return null!=a?a.failure(g,b):void 0}}(this)},c.execute(b,!1)},a.prototype["delete"]=function(a){var b,c;return g=this,j.Kii.logger("Deleting group: "+this._groupName),c=this._getRequest({path:"/groups/"+this._uuid,withApp:!0}),c.setMethod("DELETE"),b={success:function(){return function(b,c){return 300>c&&c>=200&&null!=a?a.success(g):null!=a?a.failure(g,"Unable to parse response"):void 0}}(this),failure:function(){return function(b){return null!=a?a.failure(g,b):void 0}}(this)},c.execute(b,!0)},a.prototype.getOwner=function(a){return g=this,j.Kii.logger("Getting owner of group "+this._groupName),this.refresh({success:function(){return function(b){return null!=a?a.success(b,b.getCachedOwner()):void 0}}(this),failure:function(){return function(b,c){return null!=a?a.failure(b,c):void 0}}(this)})},a.groupWithName=function(a){return j.KiiGroup.groupWithNameAndMembers(a,null)},a.groupWithNameAndMembers=function(a,b){var c;return c=new j.KiiGroup,c._setName(a),c._setAddMembers(b),c},a.groupWithURI=function(a){var b,c,d,e;if(d=null,e=a.substr("kiicloud://".length),c=e.split("/"),b=c.length,!(b>0))throw new j.InvalidURIException;return d=new j.KiiGroup,d._setUUID(c[b-1]),d},a._groupWithID=function(a){var b;return b=new j.KiiGroup,b._setUUID(a),b},a._groupWithJSON=function(a){var b;return b=new j.KiiGroup,null!=a.groupID&&b._setUUID(a.groupID),null!=a.name&&b._setName(a.name),null!=a.owner&&b._setOwner(j.KiiUser._userWithID(a.owner)),b},a.prototype._getRequest=function(a){var b,d,e;return b=a.path,e=a.withApp,d=new c(b,e)},a.prototype._userWithID=function(a){var b;return b=j.KiiUser._userWithID(a)},a.prototype._setOwnerFromContext=function(a){return null!=j.Kii.getCurrentUser()?(this._owner=j.Kii.getCurrentUser(),a.owner=this._owner.getUUID()):void 0},a}(),j.KiiObject=function(){function a(){this.deleteBody=m(this.deleteBody,this),this.publishBodyExpiresIn=m(this.publishBodyExpiresIn,this),this.publishBodyExpiresAt=m(this.publishBodyExpiresAt,this),this.publishBody=m(this.publishBody,this),this.downloadBody=m(this.downloadBody,this),this.uploadBody=m(this.uploadBody,this),this.moveBody=m(this.moveBody,this),this._parseObjectUri=m(this._parseObjectUri,this),this._userWithID=m(this._userWithID,this),this._getRequest=m(this._getRequest,this),this["delete"]=m(this["delete"],this),this.refresh=m(this.refresh,this),this.save=m(this.save,this),this.saveAllFields=m(this.saveAllFields,this),this._performSave=m(this._performSave,this),this._updateWithJSON=m(this._updateWithJSON,this),this.objectURI=m(this.objectURI,this),this.objectACL=m(this.objectACL,this),this.getGeoPoint=m(this.getGeoPoint,this),this.setGeoPoint=m(this.setGeoPoint,this),this.get=m(this.get,this),this.set=m(this.set,this),this._getPath=m(this._getPath,this),this._setBodyContentType=m(this._setBodyContentType,this),this.getBodyContentType=m(this.getBodyContentType,this),this._setBucket=m(this._setBucket,this),this.getBucket=m(this.getBucket,this),this._setObjectType=m(this._setObjectType,this),this.getObjectType=m(this.getObjectType,this),this._setModified=m(this._setModified,this),this.getModified=m(this.getModified,this),this._setCreated=m(this._setCreated,this),this.getCreated=m(this.getCreated,this),this._setUUID=m(this._setUUID,this),this.getUUID=m(this.getUUID,this),this._customInfo={}}var b,d,e,f,g,i,k,l,n;return l=null,a.prototype._alteredFields=[],n=null,e=null,g=null,i=null,f=null,d=null,k=null,b=null,a.prototype.getUUID=function(){return this._uuid},a.prototype._setUUID=function(a){this._uuid=a},a.prototype.getCreated=function(){return this._created},a.prototype._setCreated=function(a){this._created=a},a.prototype.getModified=function(){return this._modified},a.prototype._setModified=function(a){this._modified=a},a.prototype.getObjectType=function(){return this._objectType},a.prototype._setObjectType=function(a){this._objectType=a},a.prototype.getBucket=function(){return j.Kii.logger("GEtting bucket "+this._bucket),this._bucket},a.prototype._setBucket=function(a){this._bucket=a},a.prototype.getBodyContentType=function(){return this._bodyContentType},a.prototype._setBodyContentType=function(a){this._bodyContentType=a},a.prototype._getPath=function(){var a;return a=null!=this._bucket.getUser()?"/users/"+this._bucket.getUser().getUUID()+"/buckets/"+this._bucket.getBucketName()+"/objects/":null!=this._bucket.getGroup()?"/groups/"+this._bucket.getGroup().getUUID()+"/buckets/"+this._bucket.getBucketName()+"/objects/":"/buckets/"+this._bucket.getBucketName()+"/objects/",null!=this._uuid&&(a+=this._uuid),a},a.prototype.set=function(a,b){return this._customInfo[a]=b,this._alteredFields.push(a)},a.prototype.get=function(a){return this._customInfo[a]},a.prototype.setGeoPoint=function(a,b){if(!(b instanceof KiiGeoPoint))throw InvalidArgumentException("Specified kiiGeoPoint is not an instance of KiiGeoPoint");return this._customInfo[a]=b._toDict(),this._alteredFields.push(a)},a.prototype.getGeoPoint=function(a){var b,c,d;return d=this._customInfo[a],b=d.lat,c=d.lon,j.KiiGeoPoint.geoPoint(b,c)},a.prototype.objectACL=function(){return j.KiiACL.aclWithParent(this)},a.prototype.objectURI=function(){var a,b;return a="kiicloud://",null!=this._bucket&&null!=this._uuid&&(b=a,null!=this._bucket.getGroup()?b+="groups/"+this._bucket.getGroup().getUUID()+"/":null!=this._bucket.getUser()&&(b+="users/"+this._bucket.getUser().getUUID()+"/"),b+="buckets/"+this._bucket.getBucketName()+"/objects/"+this._uuid),b},a.prototype._updateWithJSON=function(a){var b,c,d;d=[];for(b in a)c=a[b],"objectID"===b||"_id"===b||"uuid"===b?(j.Kii.logger("Setting uuid: "+c),d.push(this._uuid=c)):d.push("createdAt"===b||"_created"===b||"created"===b?this._created=c:"modifiedAt"===b||"_modified"===b||"modified"===b?this._modified=c:"_owner"===b?this._owner=this._userWithID(c):"_dataType"===b?this._objectType=c:"_calculated"===b?this._customInfo[b]=c:"_"!==b[0]?this._customInfo[b]=c:void 0);return d},a.prototype._performSave=function(a,b){var c,d,e,f,g,h,i,k;if(l=this,e=this._getPath(),f=new this._getRequest({path:e,withApp:!0}),f.setMethod(null!=this._uuid?"PUT":"POST"),c={},a)c=this._customInfo;else for(k=this._alteredFields,h=0,i=k.length;i>h;h++)d=k[h],c[d]=this._customInfo[d];return f.setData(c),null!=this._objectType&&f.setContentType("application/vnd."+j.Kii.getAppID()+"."+this._objectType+"+json"),null==this._uuid||a||(f.addHeader("X-HTTP-Method-Override","PATCH"),f.setMethod("POST")),g={success:function(){return function(a,c){if(300>c&&c>=200){if(l._updateWithJSON(a),l._alteredFields=[],null!=b)return b.success(l)}else if(null!=b)return b.failure(l,"Unable to parse response")}}(this),failure:function(){return function(a){return null!=b?b.failure(l,a):void 0}}(this)},f.execute(g,!1)},a.prototype.saveAllFields=function(a){return this._performSave(!0,a)},a.prototype.save=function(a){return this._performSave(!1,a)},a.prototype.refresh=function(a){var b,c,d;return l=this,b=this._getPath(),d=new this._getRequest({path:b,withApp:!0}),c={success:function(){return function(b,c){if(300>c&&c>=200){if(l._updateWithJSON(b),null!=a)return a.success(l)}else if(null!=a)return a.failure(l,"Unable to parse response")}}(this),failure:function(){return function(b){return null!=a?a.failure(l,b):void 0}}(this)},d.execute(c,!1)},a.prototype["delete"]=function(a){var b,c,d;return l=this,b=this._getPath(),d=new this._getRequest({path:b,withApp:!0}),d.setMethod("DELETE"),c={success:function(){return function(b,c){return 300>c&&c>=200&&null!=a?a.success(l):null!=a?a.failure(l,"Unable to parse response"):void 0}}(this),failure:function(){return function(b){return null!=a?a.failure(l,b):void 0}}(this)},d.execute(c,!0)},a.objectWithBucket=function(a,b){var c;return j.Kii.logger("Creating object w type: "+b),c=new j.KiiObject,c._setBucket(a),c._setObjectType(b),j.Kii.logger(c),c},a.objectWithURI=function(a){var b,c,d,e,f,g,h,i,k,l;if(h=a.substr("kiicloud://".length),f=h.split("/"),e=f.length,j.Kii.logger(f),!(e>=4))throw new j.InvalidURIException;return c=4===e?1:3,d=f[c],"groups"===f[0]?g=new j.KiiGroup._groupWithID(f[1]):"users"===f[0]&&(l=j.KiiUser._userWithID(f[1])),k=null,null!=g?k=g:null!=l&&(k=l),b=new j.KiiBucket._bucketWithName(d,k),j.Kii.logger(b),i=b.createObject(),i._setUUID(f[e-1]),j.Kii.logger(i),i},a.prototype._getRequest=function(a){var b,d,e;return b=a.path,e=a.withApp,d=new c(b,e)},a.prototype._userWithID=function(a){var b;return b=j.KiiUser._userWithID(a)},a.prototype._parseObjectUri=function(a){var b,c,d,e;return d=a.replace(/^kiicloud:\/\//g,"").split("/"),e=d[0],"users"===e?(c={appID:j.Kii.getAppID(),userID:d[1],type:"APP_AND_USER"},b={targetObjectScope:c,targetBucketID:d[3],targetObjectID:d[5]}):"groups"===e?(c={appID:j.Kii.getAppID(),groupID:d[1],type:"APP_AND_GROUP"},b={targetObjectScope:c,targetBucketID:d[3],targetObjectID:d[5]}):(c={appID:j.Kii.getAppID(),type:"APP"},b={targetObjectScope:c,targetBucketID:d[1],targetObjectID:d[3]}),b},a.prototype.moveBody=function(a,b){var c,d,e,f;if(f=this,null==a)throw j.InvalidArgumentException("targetObjectUri is required");if(null==f.getUUID())throw j.InvalidArgumentException("Source object is not saved on the cloud");return d=this._getPath()+"/body/move",e=new this._getRequest({path:d,withApp:!0}),e.setMethod("POST"),e.setContentType("application/vnd.kii.ObjectBodyMoveRequest+json"),e.setData(this._parseObjectUri(a)),c={success:function(){return function(c,d){return 300>d&&d>=200&&null!=b?b.success(f,a):null!=b?b.failure(f,a,"Unable to parse response"):void 0}}(this),failure:function(){return function(c){return null!=b?b.failure(f,a,c):void 0}}(this)},e.execute(c,!0)},a.prototype.uploadBody=function(a,b){var c,d,e,f,g;return a&&a instanceof Blob?(l=this,e=j.Kii.getBaseURL()+"/apps/"+j.Kii.getAppID()+this._getPath()+"/body",c="application/octet-stream",a.type&&(c=a.type),f=h.createXHRWrapper("PUT",e),g=f.xhr,g.setRequestHeader("Content-Type",c),g.setRequestHeader("x-kii-appid",j.Kii.getAppID()),g.setRequestHeader("x-kii-appkey",j.Kii.getAppKey()),g.setRequestHeader("Authorization","Bearer "+j.KiiUser.getCurrentUser().getAccessToken()),d={success:function(){return function(){var a;return a=g.status,300>a&&a>=200&&null!=b?(l._setBodyContentType(c),b.success(l)):null!=b?b.failure(l,"Unable to parse response"):void 0}}(this),failure:function(){return function(){var a,c,d;try{d=JSON.parse(decodeURIComponent(g.responseText))}catch(e){c=e,d=null}return null!=d&&null!=d.errorCode&&(a=d.errorCode,null!=d.message&&(a+=": "+d.message)),j.Kii.logger("Failure: "+a),j.Kii.logger(g.responseText),null!=b?b.failure(l,a):void 0}}(this),progress:function(){return function(a){return b&&b.progress?b.progress(a):void 0}}(this)},f.sendData(a,d)):void b.failure(l,"Invalid parameter")},a.prototype.downloadBody=function(a){var b,c,d,e;return l=this,c=j.Kii.getBaseURL()+"/apps/"+j.Kii.getAppID()+this._getPath()+"/body",d=h.createXHRWrapper("GET",c),e=d.xhr,e.setRequestHeader("x-kii-appid",j.Kii.getAppID()),e.setRequestHeader("x-kii-appkey",j.Kii.getAppKey()),e.setRequestHeader("Authorization","Bearer "+j.KiiUser.getCurrentUser().getAccessToken()),e.responseType="blob",b={success:function(){return function(){var b;if(b=e.status,300>b&&b>=200&&null!=a){if(l._setBodyContentType(e.getResponseHeader("content-type")),null!=a)return a.success(l,e.response)
}else if(null!=a)return a.failure(l,"Unable to parse response")}}(this),failure:function(){return function(){var b,c;return j.Kii.logger("Failure..."),b=new FileReader,c=null,b.onload=function(){var b,d,f;c=this.result;try{f=JSON.parse(decodeURIComponent(c))}catch(g){d=g,f=null}null!=f&&null!=f.errorCode&&(b=f.errorCode,null!=f.message&&(b+=": "+f.message)),j.Kii.logger("Failure: "+b),j.Kii.logger(e.response),null!=a&&a.failure(l,b)},b.readAsText(e.response)}}(this),progress:function(){return function(b){return a&&a.progress?a.progress(b):void 0}}(this)},d.send(b)},a.prototype.publishBody=function(a){var b,c,d;return l=this,b=this._getPath()+"/body/publish",d=new this._getRequest({path:b,withApp:!0}),d.setMethod("POST"),d.setContentType("application/vnd.kii.ObjectBodyPublicationRequest+json"),d.setData({}),c={success:function(){return function(b,c){return 300>c&&c>=200&&null!=a?a.success(l,b.url):null!=a?a.failure(l,"Unable to parse response"):void 0}}(this),failure:function(){return function(b){return null!=a?a.failure(l,b):void 0}}(this)},d.execute(c,!1)},a.prototype.publishBodyExpiresAt=function(a,b){var c,d,e,f;return l=this,c=this._getPath()+"/body/publish",e=new this._getRequest({path:c,withApp:!0}),f={},f.expiresAt=a,e.setMethod("POST"),e.setContentType("application/vnd.kii.ObjectBodyPublicationRequest+json"),e.setData(f),d={success:function(){return function(a,c){return 300>c&&c>=200&&null!=b?b.success(l,a.url):null!=b?b.failure(l,"Unable to parse response"):void 0}}(this),failure:function(){return function(a){return null!=b?b.failure(l,a):void 0}}(this)},e.execute(d,!1)},a.prototype.publishBodyExpiresIn=function(a,b){var c,d,e,f;return l=this,c=this._getPath()+"/body/publish",e=new this._getRequest({path:c,withApp:!0}),f={},f.expiresIn=a,e.setMethod("POST"),e.setContentType("application/vnd.kii.ObjectBodyPublicationRequest+json"),e.setData(f),d={success:function(){return function(a,c){return 300>c&&c>=200&&null!=b?b.success(l,a.url):null!=b?b.failure(l,"Unable to parse response"):void 0}}(this),failure:function(){return function(a){return null!=b?b.failure(l,a):void 0}}(this)},e.execute(d,!1)},a.prototype.deleteBody=function(a){var b,c,d;return l=this,b=this._getPath()+"/body",d=new this._getRequest({path:b,withApp:!0}),d.setMethod("DELETE"),c={success:function(){return function(b,c){return 300>c&&c>=200&&null!=a?(l._setBodyContentType(null),a.success(l)):null!=a?a.failure(l,"Unable to parse response"):void 0}}(this),failure:function(){return function(b){return null!=a?a.failure(l,b):void 0}}(this)},d.execute(c,!0)},a}(),j.KiiQuery=function(){function a(a){return this._dictValue=m(this._dictValue,this),this.sortByAsc=m(this.sortByAsc,this),this.sortByDesc=m(this.sortByDesc,this),this.setLimit=m(this.setLimit,this),this.getLimit=m(this.getLimit,this),this._setClause=m(this._setClause,this),this.setPaginationKey=m(this.setPaginationKey,this),this.getPaginationKey=m(this.getPaginationKey,this),this._clone=m(this._clone,this),this._clone(a)}var b,c,d,e,f,g,h;return h=null,c=null,e=null,f=!1,g=null,d=25,b=null,a.prototype._clone=function(a){var b,c;if(null==a||"object"!=typeof a)return a;c=new a.constructor;for(b in a)c[b]=this._clone(a[b]);return c},a.prototype.getPaginationKey=function(){return this._paginationKey},a.prototype.setPaginationKey=function(a){this._paginationKey=a},a.prototype._setClause=function(a){this._clause=a},a.prototype.getLimit=function(){return this._limit},a.prototype.setLimit=function(a){if(a>0)return this._limit=a;throw new j.InvalidLimitException},a.queryWithClause=function(a){var b;return b=new j.KiiQuery,b._setClause(a),b},a.prototype.sortByDesc=function(a){return this._sortField=a,this._sortDescending=!0},a.prototype.sortByAsc=function(a){return this._sortField=a,this._sortDescending=!1},a._emptyDictValue=function(){return{type:"all"}},a.prototype._dictValue=function(){var a,b;return b={},b.bestEffortLimit=this._limit,null!=this._paginationKey&&(b.paginationKey=this._paginationKey),a={descending:this._sortDescending},a.clause=null!=this._clause?this._clause._getDictValue():j.KiiQuery._emptyDictValue(),null!=this._sortField&&(a.orderBy=this._sortField),b.bucketQuery=a,b},a}(),j.KiiClause=function(){function a(){this._getDictValue=m(this._getDictValue,this),this._setDictValue=m(this._setDictValue,this),this._setWhereClauses=m(this._setWhereClauses,this),this._setWhereType=m(this._setWhereType,this)}var b,c,d;return b=null,d=null,c=null,a.constructor=function(){return a._whereClauses=[],a._dictExpression={}},a.prototype._setWhereType=function(a){this._whereType=a},a.prototype._setWhereClauses=function(a){this._whereClauses=a},a.prototype._setDictValue=function(a){this._dictExpression=a},a.prototype._getDictValue=function(){var a,b,c,d,e,f;if(c={},null!=this._whereClauses&&null!=this._whereType)if(b=[],1===this._whereClauses.length)a=this._whereClauses[0],c="not"===this._whereType?{type:this._whereType,clause:a._getDictValue()}:a._getDictValue();else{for(f=this._whereClauses,d=0,e=f.length;e>d;d++)a=f[d],b.push(a._getDictValue());c={type:this._whereType,clauses:b}}else null!=this._whereClauses?this._whereClauses.length>0&&(c=this._whereClauses[0]._getDictValue()):null!=this._dictExpression&&(c=this._dictExpression);return null==c&&(c=j.KiiQuery.emptyDictValue()),c},a.createWithWhere=function(a,b){var c;return c=new j.KiiClause,c._setWhereType(a),c._setWhereClauses(b),c},a.create=function(a,b,c){var d,e;return d=new j.KiiClause,e={},"="===a?(e.type="eq",e.field=b,e.value=c):"<"===a?(e.type="range",e.field=b,e.upperLimit=c,e.upperIncluded=!1):"<="===a?(e.type="range",e.field=b,e.upperLimit=c,e.upperIncluded=!0):">"===a?(e.type="range",e.field=b,e.lowerLimit=c,e.lowerIncluded=!1):">="===a?(e.type="range",e.field=b,e.lowerLimit=c,e.lowerIncluded=!0):"in"===a?(e.type="in",e.field=b,e.values=c):"prefix"===a&&(e.type="prefix",e.field=b,e.prefix=c),d._setDictValue(e),d},a.and=function(){return a.createWithWhere("and",arguments)},a.or=function(){return a.createWithWhere("or",arguments)},a.equals=function(a,b){return null!=b._className&&(b=b.objectURI),j.KiiClause.create("=",a,b)},a.notEquals=function(a,b){return null!=b._className&&(b=b.objectURI),j.KiiClause.createWithWhere("not",[j.KiiClause.equals(a,b)])},a.greaterThan=function(a,b){return j.KiiClause.create(">",a,b)},a.greaterThanOrEqual=function(a,b){return j.KiiClause.create(">=",a,b)},a.lessThan=function(a,b){return j.KiiClause.create("<",a,b)},a.lessThanOrEqual=function(a,b){return j.KiiClause.create("<=",a,b)},a["in"]=function(a,b){return j.KiiClause.create("in",a,b)},a.startsWith=function(a,b){return j.KiiClause.create("prefix",a,b)},a.geoDistance=function(a,b,c,d){var e,f,g,h,i;if(g=function(a){return"string"==typeof a&&a.length>0},f=function(a){return null==a?!1:a instanceof KiiGeoPoint},!g(a))throw j.InvalidArgumentException("Specified key is not a string or is an empty string.");if(!f(b))throw j.InvalidArgumentException("center is not a reference of KiiGeoPoint.");if(h="^[a-zA-Z_][a-zA-Z0-9_]*$",null!=d&&!d.match(h))throw j.InvalidArgumentException("putDistanceInto is invalid.");if(0>=c||c>2e7||isNaN(c))throw j.InvalidArgumentException("radius is invalid.");return e=new j.KiiClause,i={},i.type="geodistance",i.field=a,b=b._toDict(),i.center=b,i.radius=c,i.putDistanceInto=d,e._setDictValue(i),e},a.geoBox=function(a,b,c){var d,e,f,g,h,i;if(f=function(a){return"string"==typeof a&&a.length>0},e=function(a){return null==a?!1:a instanceof KiiGeoPoint},!f(a))throw j.InvalidArgumentException("Specified key is not a string or is an empty string.");if(!e(b)||!e(c))throw j.InvalidArgumentException("northEast or southWest is not a reference of KiiGeoPoint.");return d=new j.KiiClause,i={},i.type="geobox",i.field=a,g=b._toDict(),h=c._toDict(),i.box={ne:g,sw:h},d._setDictValue(i),d},a}(),c=function(){function a(a,b){this.execute=m(this.execute,this),this.setAdminToken=m(this.setAdminToken,this),this.addHeader=m(this.addHeader,this),this.setAccept=m(this.setAccept,this),this.getAccept=m(this.getAccept,this),this.setAnonymous=m(this.setAnonymous,this),this.isAnonymous=m(this.isAnonymous,this),this.setContentType=m(this.setContentType,this),this.getContentType=m(this.getContentType,this),this.setData=m(this.setData,this),this.getData=m(this.getData,this),this.setHeaders=m(this.setHeaders,this),this.getHeaders=m(this.getHeaders,this),this.setMethod=m(this.setMethod,this),this.getMethod=m(this.getMethod,this),this.setPath=m(this.setPath,this),this.getPath=m(this.getPath,this),this._path=b?"/apps/"+j.Kii.getAppID()+a:a,this._method="GET",this._headers={accept:"*/*"},this._contentType="application/json",this._anonymous=!1,this._success=function(){return function(){}}(this),this._failure=function(){return function(){}}(this),this._httpRequest=null}var c;return a._path=null,a._method=null,a._headers=null,a._data=null,a._contentType=null,a._anonymous=!1,a._accept=null,a._success=null,a._failure=null,c=null,a.prototype.getPath=function(){return this._path},a.prototype.setPath=function(a){this._path=a},a.prototype.getMethod=function(){return this._method},a.prototype.setMethod=function(a){this._method=a},a.prototype.getHeaders=function(){return this._headers},a.prototype.setHeaders=function(a){this._headers=a},a.prototype.getData=function(){return this._data},a.prototype.setData=function(a){this._data=a},a.prototype.getContentType=function(){return this._contentType},a.prototype.setContentType=function(a){this._contentType=a},a.prototype.isAnonymous=function(){return this._anonymous},a.prototype.setAnonymous=function(a){this._anonymous=a},a.prototype.getAccept=function(){return this._accept},a.prototype.setAccept=function(a){this._accept=a},a.prototype.addHeader=function(a,b){return this._headers[a]=b},a.prototype.setAdminToken=function(a){return this._adminToken=a},a.prototype.execute=function(a,b){var c,d,e,f,g,h,i,k,l,m;this._success=null!=a.success?a.success:this._success,this._failure=null!=a.failure?a.failure:this._failure,this._ignoreBody=b,h=j.Kii.getBaseURL()+this._path,j.Kii.logger("POSTING: "),j.Kii.logger(this._data),null!=this._data&&(g={}),l=this._data;for(e in l)i=l[e],g[e]=encodeURIComponent(i);if(d=JSON.stringify(this._data),j.Kii.logger("Making request["+this._method+"] to "+h+" with data: "+d),c=j.Kii.getAdditionalHeaders(),null!=c)for(f in c)k=c[f],this._headers[f]=k;this._headers["x-kii-appid"]=j.Kii.getAppID(),this._headers["x-kii-appkey"]=j.Kii.getAppKey(),this._headers["x-kii-sdk"]=j.KiiSDKClientInfo.getSDKClientInfo(),null!=this._accept&&(this._headers.accept=this._accept),this._anonymous||null==j.KiiUser.getCurrentUser()||(this._headers.Authorization="Bearer "+j.KiiUser.getCurrentUser().getAccessToken()),null!=this._adminToken&&(this._headers.Authorization="Bearer "+this._adminToken),null!=this._contentType&&(this._headers["Content-Type"]=this._contentType),j.Kii.logger("Headers: "),j.Kii.logger(this._headers),a={onComplete:function(a){return function(){var b,c,d,e,f,g;if(f=a._httpRequest.xhr,4===f.readyState){if(200<=(g=f.status)&&400>g){if(j.Kii.logger("Completed Request["+f.status+"]"),j.Kii.logger(f.responseText),a._ignoreBody)return a._success(null,f.status);try{e=JSON.parse(f.responseText)}catch(h){b=h,e=null}return null!=e?null!=e.errorCode?(c=e.errorCode,null!=e.message&&(c+=": "+e.message),a._failure(c,f.status,e.errorCode)):a._success(e,f.status):a._success(null,f.status,null)}j.Kii.logger("Error loading data..."),c=f.status+" : "+j.Kii.getBaseURL()+a._path;try{e=JSON.parse(decodeURIComponent(f.responseText))}catch(h){d=h,e=null}return null!=e&&null!=e.errorCode&&(c=e.errorCode,null!=e.message&&(c+=": "+e.message)),j.Kii.logger("Failure: "+c),j.Kii.logger(f.responseText),a._failure(c,f.status)}}}(this),onError:function(a){return function(){var b,c,d,e;e=a._httpRequest.xhr,j.Kii.logger("Error loading data..."),b=e.status+" : "+j.Kii.getBaseURL()+a._path;try{d=JSON.parse(decodeURIComponent(e.responseText))}catch(f){c=f,d=null}return null!=d&&null!=d.errorCode&&(b=d.errorCode,null!=d.message&&(b+=": "+d.message)),j.Kii.logger("Failure: "+b),j.Kii.logger(e.responseText),a._failure(b,e.status)}}(this)},this._httpRequest=this._createHttpRequest(this._method,h,a),null==this._httpRequest.xhr&&this._failure("Cross-Origin Resource Sharing is not supported by the browser.",0),m=this._headers;for(e in m)k=m[e],this._httpRequest.xhr.setRequestHeader(e,k);return"GET"!==this._method&&"DELETE"!==this._method?this._httpRequest.xhr.send(d):this._httpRequest.xhr.send()},a.prototype._createHttpRequest=function(a,c,d){var f;return f=null,null===j.Kii._getHttpRequestType()?"undefined"!=typeof jQuery?(j.Kii.logger("Use jQuery"),f=new b(a,c,d)):"undefined"!=typeof XMLHttpRequest?(j.Kii.logger("Use XMLHttpRequest"),f=new i(a,c,d)):"undefined"!=typeof Titanium&&(j.Kii.logger("Use Titanium"),f=new e(a,c,d)):(j.Kii.logger("Use http request backdoor"),j.Kii._getHttpRequestType()===j._KiiHttpRequestType.jQuery?(j.Kii.logger("Use jQuery"),f=new b(a,c,d)):j.Kii._getHttpRequestType()===j._KiiHttpRequestType.XMLHttpRequest?(j.Kii.logger("Use XMLHttpRequest"),f=new i(a,c,d)):j.Kii._getHttpRequestType()===j._KiiHttpRequestType.Titanium&&(j.Kii.logger("Use Titanium"),f=new e(a,c,d))),f},a}(),j.KiiUser=function(){function a(){this._getRequest=m(this._getRequest,this),this._updateWithJSON=m(this._updateWithJSON,this),this["delete"]=m(this["delete"],this),this.refresh=m(this.refresh,this),this.save=m(this.save,this),this.changeEmail=m(this.changeEmail,this),this.changePhone=m(this.changePhone,this),this.ownerOfGroups=m(this.ownerOfGroups,this),this.memberOfGroups=m(this.memberOfGroups,this),this.resendPhoneNumberVerification=m(this.resendPhoneNumberVerification,this),this.resendEmailVerification=m(this.resendEmailVerification,this),this.resendVerification=m(this.resendVerification,this),this.verifyPhoneNumber=m(this.verifyPhoneNumber,this),this.verifyCredentials=m(this.verifyCredentials,this),this.updatePassword=m(this.updatePassword,this),this.register=m(this.register,this),this._authenticateWithToken=m(this._authenticateWithToken,this),this._authenticate=m(this._authenticate,this),this.bucketWithName=m(this.bucketWithName,this),this.get=m(this.get,this),this.set=m(this.set,this),this.objectURI=m(this.objectURI,this),this._setAccessToken=m(this._setAccessToken,this),this.getAccessToken=m(this.getAccessToken,this),this._setPhoneVerified=m(this._setPhoneVerified,this),this.getPhoneVerified=m(this.getPhoneVerified,this),this._setEmailVerified=m(this._setEmailVerified,this),this.getEmailVerified=m(this.getEmailVerified,this),this._setModified=m(this._setModified,this),this.getModified=m(this.getModified,this),this._setCreated=m(this._setCreated,this),this.getCreated=m(this.getCreated,this),this.setCountry=m(this.setCountry,this),this.getCountry=m(this.getCountry,this),this._setPassword=m(this._setPassword,this),this._setPhoneNumber=m(this._setPhoneNumber,this),this.getPhoneNumber=m(this.getPhoneNumber,this),this._setEmailAddress=m(this._setEmailAddress,this),this.getEmailAddress=m(this.getEmailAddress,this),this._validateDisplayName=m(this._validateDisplayName,this),this.setDisplayName=m(this.setDisplayName,this),this.getDisplayName=m(this.getDisplayName,this),this._setUsername=m(this._setUsername,this),this.getUsername=m(this.getUsername,this),this._setUUID=m(this._setUUID,this),this.getUUID=m(this.getUUID,this),this._customInfo={}}var b,d,e,g,h,i,k,l,n,o,p,q,r,s;return q=null,s=null,r=null,h=null,n=null,i=null,o=null,d=null,e=null,l=null,k=null,p=null,b=null,g=null,a.prototype.getUUID=function(){return this._uuid},a.prototype._setUUID=function(a){this._uuid=a},a.prototype.getUsername=function(){return this._username},a.prototype._setUsername=function(a){var b;if(b=f._trim(a),j.Kii.logger("Setting username: "+b),f._validateUsername(b))return this._username=b;throw new j.InvalidUsernameException},a.prototype.getDisplayName=function(){return this._displayName},a.prototype.setDisplayName=function(a){return this._validateDisplayName(a),this._displayName=a},a.prototype._validateDisplayName=function(a){if(typeof a===!1)throw new j.InvalidDisplayNameException;if(4>a.length||a.length>50)throw new j.InvalidDisplayNameException},a.prototype.getEmailAddress=function(){return this._emailAddress},a.prototype._setEmailAddress=function(a){var b;if(b=f._trim(a),j.Kii.logger("Setting email: "+b),f._validateEmail(b))return this._emailAddress=b;throw new j.InvalidEmailException},a.prototype.getPhoneNumber=function(){return this._phoneNumber},a.prototype._setPhoneNumber=function(a){if(j.Kii.logger("Setting phone number: "+a),f._validatePhoneNumber(a))return this._phoneNumber=a;throw new j.InvalidPhoneNumberException},a.prototype._setPassword=function(a){if(f._validatePassword(a))return this._password=a;throw new j.InvalidPasswordException},a.prototype.getCountry=function(){return this._country},a.prototype.setCountry=function(a){if(f._validateCountryCode(a))return this._country=a;throw new j.InvalidCountryException},a.prototype.getCreated=function(){return this._created},a.prototype._setCreated=function(a){this._created=a},a.prototype.getModified=function(){return this._modified},a.prototype._setModified=function(a){this._modified=a},a.prototype.getEmailVerified=function(){return this._emailVerified},a.prototype._setEmailVerified=function(a){this._emailVerified=a},a.prototype.getPhoneVerified=function(){return this._phoneVerified},a.prototype._setPhoneVerified=function(a){this._phoneVerified=a},a.prototype.getAccessToken=function(){return j.Kii.logger("Getting access token: "+this._accessToken),this._accessToken},a.prototype._setAccessToken=function(a){return this._accessToken=a,j.Kii.logger("Setting access token: "+this._accessToken)},a.prototype.objectURI=function(){var a;return null!=this._uuid&&(a="kiicloud://users/"+this._uuid),a},a.prototype.set=function(a,b){return j.Kii.logger(this),j.Kii.logger(this._customInfo),this._customInfo[a]=b},a.prototype.get=function(a){return this._customInfo[a]},a.getCurrentUser=function(){return j.Kii.getCurrentUser()},a.userWithUsername=function(a,b){var c;return c=new j.KiiUser,c._setUsername(a),c._setPassword(b),c},a._userWithEmailAddress=function(a,b){var c;return c=new j.KiiUser,c._setEmailAddress(a),c._setPassword(b),c},a._userWithPhoneNumber=function(a,b){var c;return c=new j.KiiUser,c._setPhoneNumber(a),c._setPassword(b),c},a.userWithPhoneNumber=function(a,b){var c;return c=new j.KiiUser,c._setPhoneNumber(a),c._setPassword(b),c},a.userWithPhoneNumberAndUsername=function(a,b,c){var d;return d=new j.KiiUser,d._setPhoneNumber(a),d._setUsername(b),d._setPassword(c),d},a.userWithEmailAddress=function(a,b){var c;return c=new j.KiiUser,c._setEmailAddress(a),c._setPassword(b),c},a.userWithEmailAddressAndUsername=function(a,b,c){var d;return d=new j.KiiUser,d._setEmailAddress(a),d._setUsername(b),d._setPassword(c),d},a.userWithEmailAddressAndPhoneNumber=function(a,b,c){var d;return d=new j.KiiUser,d._setEmailAddress(a),d._setPhoneNumber(b),d._setPassword(c),d},a.userWithCredentials=function(a,b,c,d){var e;return e=new j.KiiUser,e._setEmailAddress(a),e._setPhoneNumber(b),e._setUsername(c),e._setPassword(d),e},a._validateURI=function(a){var b,c,d;return a=f._trim(a),c=/^kiicloud:\/\/users\/(.*$)/i,"string"===(typeof a).toLowerCase()&&(b=a.match(c),null!=b&&(d=b[1])),d},a.userWithURI=function(a){var b,c;if(j.Kii.logger("About to extract from: "+a),c=j.KiiUser._validateURI(a),j.Kii.logger("Extracted uuid from uri: "+c),null==c)throw new j.InvalidURIException;return b=new j.KiiUser,b._setUUID(c),b},a._userWithID=function(a){var b;return b=new j.KiiUser,b._setUUID(a),b},a.prototype.bucketWithName=function(a){return new j.KiiBucket._bucketWithName(a,this)},a.prototype._authenticate=function(a){var b,c,d;return q=this,j.Kii.logger("Authenticating user:"),j.Kii.logger(this),j.Kii.logger("Email verified: "+this._emailVerified),j.Kii.logger("Phone verified: "+this._phoneVerified),null!=this._username?d=this._username:null!=this._emailAddress&&this._emailVerified===!0?d=this._emailAddress:null!=this._phoneNumber&&this._phoneVerified===!0?d=this._phoneNumber:null!=this._emailAddress?d=this._emailAddress:null!=this._phoneNumber&&(d=this._phoneNumber),c=this._getRequest({path:"/oauth2/token",withApp:!1}),c.setAnonymous(!0),c.setMethod("POST"),c.setData({username:d,password:this._password}),b={success:function(){return function(b){return q._setUUID(b.id),q._setAccessToken(b.access_token),j.Kii.setCurrentUser(q),null!=a?a.success(j.Kii.getCurrentUser()):void 0}}(this),failure:function(){return function(b){return null!=a?a.failure(q,b):void 0}}(this)},c.execute(b,!1)},a.prototype._authenticateWithToken=function(a,b){var c,d;return q=this,j.Kii.logger("Authenticating user "+this),j.Kii.logger(b),d=this._getRequest({path:"/users/me",withApp:!0}),d.setAnonymous(!0),d.addHeader("Authorization","Bearer "+a),c={success:function(){return function(c){return q._updateWithJSON(c),q._setAccessToken(a),j.Kii.setCurrentUser(q),null!=b?b.success(j.Kii.getCurrentUser()):void 0}}(this),failure:function(){return function(a){return null!=b?b.failure(q,a):void 0}}(this)},d.execute(c,!1)},a.authenticate=function(a,b,c){var d,e;try{if(j.Kii.logger("UserIdentifier: "+a),!f._validatePassword(b))throw new j.InvalidPasswordException;if(f._validateEmail(a))e=j.KiiUser._userWithEmailAddress(a,b);else if(f._validatePhoneNumber(a))e=j.KiiUser._userWithPhoneNumber(a,b);else{if(!f._validateUsername(a))throw new j.InvalidUserIdentifierException;e=j.KiiUser.userWithUsername(a,b)}return e._authenticate(c)}catch(g){if(d=g,null!=c)return c.failure(null,d.message)}},a.authenticateWithToken=function(a,b){var c;return c=new j.KiiUser,c._authenticateWithToken(a,b)},a.prototype.register=function(a){var b,c,d,e,f,g;q=this,j.Kii.logger("Registering user "+this),b={password:this._password},null!=this._username&&(b.loginName=this._username),null!=this._displayName&&(b.displayName=this._displayName),null!=this._emailAddress&&(b.emailAddress=this._emailAddress),null!=this._phoneNumber&&(b.phoneNumber=this._phoneNumber),null!=this._country&&(b.country=this._country),j.Kii.logger("CINFO"),j.Kii.logger(this._customInfo),g=this._customInfo;for(c in g)f=g[c],j.Kii.logger("Key/val: "+c+"/"+f),b[c]=f;return e=this._getRequest({path:"/users",withApp:!0}),e.setMethod("POST"),e.setData(b),e.setAnonymous(!0),e.setContentType("application/vnd.kii.RegistrationRequest+json"),d={success:function(){return function(b){return j.Kii.logger("Succreg"),q._updateWithJSON(b),q._authenticate(a)}}(this),failure:function(){return function(b){return j.Kii.logger("Failreg"),null!=a?a.failure(q,b):void 0}}(this)},e.execute(d,!1)},a.prototype.updatePassword=function(a,b,c){var d,e,g,h;return q=this,j.Kii.logger("Updating password from "+a+" to "+b),f._validatePassword(b)?(d={oldPassword:a,newPassword:b},e="/users/"+this._uuid+"/password",g=this._getRequest({path:e,withApp:!0}),g.setMethod("PUT"),g.setData(d),g.setContentType("application/vnd.kii.ChangePasswordRequest+json"),h={success:function(){return function(a,d){if(300>d&&d>=200){if(q._setPassword(b),null!=c)return c.success(q)}else if(null!=c)return c.failure(q,"Unable to change password")}}(this),failure:function(){return function(a){return null!=c?c.failure(q,a):void 0}}(this)},g.execute(h,!0)):null!=c?c.failure(q,(new j.InvalidPasswordException).message):void 0},a.resetPassword=function(a,b){var d,e,g,h;if(j.Kii.logger("Resetting password with identifier: "+a),f._validateEmail(a))d="EMAIL";else if(null!=b)return void b.failure("Invalid user identifier. Must be a valid email address");return null!=d?(e="/users/"+d+":"+a+"/password/request-reset",g=new c(e,!0),g.setMethod("POST"),g.setAnonymous(!0),h={success:function(a,c){return 300>c&&c>=200&&null!=b?b.success():null!=b?b.failure("Unable to reset password"):void 0},failure:function(a){return null!=b?b.failure(a):void 0}},g.execute(h,!0)):void 0},a.prototype.verifyCredentials=function(a,b,c){var d,e,f;return q=this,j.Kii.logger("Verifying "+a+" with code: "+b),d="/users/me/"+a+"/verify",e=this._getRequest({path:d,withApp:!0}),e.setMethod("POST"),e.setData({verificationCode:b}),e.setContentType("application/vnd.kii.AddressVerificationRequest+json"),f={success:function(){return function(b,d){if(300>d&&d>=200){if("email-address"===a?q._setEmailVerified(!0):"phone-number"===a&&q._setPhoneVerified(!0),null!=c)return c.success(q)}else if(null!=c)return c.failure(q,"Unable to verify "+a)}}(this),failure:function(){return function(a){return null!=c?c.failure(q,a):void 0}}(this)},e.execute(f,!0)},a.prototype.verifyPhoneNumber=function(a,b){return this.verifyCredentials("phone-number",a,b)},a.prototype.resendVerification=function(a,b){var c,d,e;return q=this,j.Kii.logger("Resending verification "+a),c="/users/me/"+a+"/resend-verification",d=this._getRequest({path:c,withApp:!0}),d.setMethod("POST"),e={success:function(){return function(c,d){return 300>d&&d>=200&&null!=b?b.success(q):null!=b?b.failure(q,"Unable to resend "+a+" verification"):void 0}}(this),failure:function(){return function(a){return null!=b?b.failure(q,a):void 0}}(this)},d.execute(e,!0)},a.prototype.resendEmailVerification=function(a){return this.resendVerification("email-address",a)},a.prototype.resendPhoneNumberVerification=function(a){return this.resendVerification("phone-number",a)},a.prototype.memberOfGroups=function(a){var b,c,d;return q=this,j.Kii.logger("Getting groups for member "+this._uuid),c="/groups/?is_member="+this._uuid,d=this._getRequest({path:c,withApp:!0}),d.setAccept("application/vnd.kii.GroupsRetrievalResponse+json"),b={success:function(){return function(b,c){var d,e,f,g,h;if(300>c&&c>=200){for(e=[],h=b.groups,f=0,g=h.length;g>f;f++)d=h[f],e.push(j.KiiGroup._groupWithJSON(d));if(null!=a)return a.success(q,e)}else if(null!=a)return a.failure(q,"Unable to retrieve groups")}}(this),failure:function(){return function(b){return null!=a?a.failure(q,b):void 0}}(this)},d.execute(b,!1)},a.prototype.ownerOfGroups=function(a){var b,c,d;return q=this,j.Kii.logger("Getting groups owned by the user "+this._uuid),c="/groups/?owner="+this._uuid,d=this._getRequest({path:c,withApp:!0}),d.setAccept("application/vnd.kii.GroupsRetrievalResponse+json"),b={success:function(){return function(b,c){var d,e,f,g,h;if(300>c&&c>=200){for(e=[],h=b.groups,f=0,g=h.length;g>f;f++)d=h[f],e.push(j.KiiGroup._groupWithJSON(d));if(null!=a)return a.success(q,e)}else if(null!=a)return a.failure(q,"Unable to retrieve groups")}}(this),failure:function(){return function(b){return null!=a?a.failure(q,b):void 0}}(this)},d.execute(b,!1)},a.prototype.changePhone=function(a,b){var c,d,e;return q=this,j.Kii.logger("Updating phone number to "+a),c="/users/"+this._uuid+"/phone-number",d=this._getRequest({path:c,withApp:!0}),d.setMethod("PUT"),d.setContentType("application/vnd.kii.PhoneNumberModificationRequest+json"),d.setData({phoneNumber:a}),e={success:function(){return function(c,d){return 300>d&&d>=200&&null!=b?(q._setPhoneVerified(!1),q._setPhoneNumber(a),b.success(q)):null!=b?b.failure(q,"Unable to update phone number"):void 0}}(this),failure:function(){return function(a){return null!=b?b.failure(q,a):void 0}}(this)},d.execute(e,!0)},a.prototype.changeEmail=function(a,b){var c,d,e;return q=this,j.Kii.logger("Updating email address to: "+a),f._validateEmail(a)?(c="/users/"+this._uuid+"/email-address",d=this._getRequest({path:c,withApp:!0}),d.setMethod("PUT"),d.setContentType("application/vnd.kii.EmailAddressModificationRequest+json"),d.setData({emailAddress:a}),e={success:function(){return function(c,d){return 300>d&&d>=200&&null!=b?(q._setEmailVerified(!1),q._setEmailAddress(a),b.success(q)):null!=b?b.failure(q,"Unable to update email address"):void 0}}(this),failure:function(){return function(a){return null!=b?b.failure(q,a):void 0}}(this)},d.execute(e,!0)):b.failure(q,"Invalid email address format")},a.prototype.save=function(a){var b,c,d,e;return q=this,j.Kii.logger("Saving user: "+this._uuid),c="/users/"+this._uuid,j.Kii.logger("CUSTOMINFO: "),j.Kii.logger(this._customInfo),d=this._getRequest({path:c,withApp:!0}),d.setMethod("POST"),d.setContentType("application/vnd.kii.UserUpdateRequest+json"),b=this._customInfo,null!=this._country&&(b.country=this._country),null!=this._displayName&&(b.displayName=this._displayName),d.setData(b),e={success:function(){return function(b,c){if(300>c&&c>=200){if(q._setModified(b.modifiedAt),null!=a)return a.success(q)}else if(null!=a)return a.failure(q,"Unable to parse response")}}(this),failure:function(){return function(b){return null!=a?a.failure(q,b):void 0}}(this)},d.execute(e,!1)},a.prototype.refresh=function(a){var b,c;return q=this,j.Kii.logger("Refreshing user: "+this._uuid),c=this._getRequest({path:"/users/"+this._uuid,withApp:!0}),b={success:function(){return function(b,c){if(300>c&&c>=200){if(q._updateWithJSON(b),null!=a)return a.success(q)}else if(null!=a)return a.failure(q,"Unable to parse response")}}(this),failure:function(){return function(b){return null!=a?a.failure(q,b):void 0}}(this)},c.execute(b,!1)},a.prototype["delete"]=function(a){var b,c;return j.Kii.logger("Deleting user..."),q=this,c=this._getRequest({path:"/users/"+this._uuid,withApp:!0}),c.setMethod("DELETE"),b={success:function(){return function(b,c){return 300>c&&c>=200&&null!=a?a.success(q):null!=a?a.failure(q,"Unable to parse response"):void 0}}(this),failure:function(){return function(b){return null!=a?a.failure(q,b):void 0}}(this)},c.execute(b,!0)},a.logOut=function(){return j.Kii.logOut()},a.loggedIn=function(){return j.Kii.loggedIn()},a.getCurrentUser=function(){return j.Kii.getCurrentUser()},a.prototype._updateWithJSON=function(a){var b,c,d;j.Kii.logger("Updating with:"),j.Kii.logger(a),d=[];for(b in a)c=a[b],j.Kii.logger("key/val => "+b+"/"+c),j.Kii.logger("Substr "+b.substring(0,1)),"userID"===b||"id"===b?d.push(this._uuid=c):"created"===b||"createdAt"===b||"_created"===b?d.push(this._created=c):"modified"===b||"modifiedAt"===b||"_modified"===b?d.push(this._modified=c):"loginName"===b?d.push(this._username=c):"displayName"===b?d.push(this._displayName=c):"country"===b?(j.Kii.logger("Is setting country"),d.push(this._country=c)):"emailAddress"===b?d.push(this._emailAddress=c):"phoneNumber"===b?d.push(this._phoneNumber=c):"emailAddressVerified"===b?(j.Kii.logger("Email verified: "+c),d.push(this._emailVerified=c)):"phoneNumberVerified"===b?(j.Kii.logger("Phone verified: "+c),d.push(this._phoneVerified=c)):""===b?(j.Kii.logger("Setting empty to custom info"),d.push(this._customInfo[b]=c)):b.substring(0,!0)?(j.Kii.logger("Setting to custom info"),d.push(this._customInfo[b]=c)):d.push(j.Kii.logger("Doing nothing"));return d},a.prototype._getRequest=function(a){var b,d,e;return b=a.path,e=a.withApp,d=new c(b,e)},a}(),f=function(){function a(){}return a.arrayRemove=function(a,b,c){var d;return d=a.slice((c||b)+1||a.length),a.length=0>b?a.length+b:b,a.push.apply(a,d)},a._validateEmail=function(b){var c;return b=a._trim(b),c=/^[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,6}$/i,"string"!==(typeof b).toLowerCase()?(j.Kii.logger("Not string"),!1):b.match(c)?!0:!1},a._validatePhoneNumber=function(b){var c;return b=a._trim(b),c=/^[\\+]+[0-9]{10,}$/i,"string"!==(typeof b).toLowerCase()?(j.Kii.logger("Not string"),!1):b.match(c)?!0:!1},a._validateLocalPhone=function(b){var c;return b=a._trim(b),c=/^\d+$/,"string"!==(typeof b).toLowerCase()?(j.Kii.logger("Not string"),!1):b.match(c)?!0:(j.Kii.logger("Invalid format"),!1)},a._assertLocalPhoneIsValid=function(b){if(!a._validateLocalPhone(b))throw new j.InvalidLocalPhoneNumberException},a._validateCountryCode=function(b){var c;return b=a._trim(b),c=/^[a-z]{2}$/i,"string"!==(typeof b).toLowerCase()?(j.Kii.logger("Not string"),!1):b.match(c)?(j.Kii.logger("Is true"),!0):!1},a._assertCountryCodeIsValid=function(b){if(!a._validateCountryCode(b))throw new j.InvalidCountryException},a._validatePassword=function(a){var b;return j.Kii.logger("Validating password: "+a),b=/^[\x20-\x7E]{4,50}$/,"string"!==(typeof a).toLowerCase()?(j.Kii.logger("not string"),!1):a.match(b)?(j.Kii.logger("matched"),!0):(j.Kii.logger("other exception"),!1)
},a._assertPasswordIsValid=function(b){if(!a._validatePassword(b))throw new j.InvalidPasswordException},a._validateUsername=function(a){var b;return b=/^[a-zA-Z0-9-_\\.]{3,64}$/i,"string"!==(typeof a).toLowerCase()?!1:a.match(b)?!0:!1},a._trim=function(a){var b;return b=/^(\s|\u00A0)+|(\s|\u00A0)+$/g,(a||"").replace(b,"")},a}(),j.KiiSocialConnect=function(){function a(){}var b;return b=null,a.setupNetwork=function(a,c,d,e){var f;return null==b&&(b=new l),f=b._getManager(a),f._reset(),f._setup(c,d,e),j.Kii.logger("Set key: "+f._key)},a.logIn=function(a,c,d){var e;return e=!1,null!=b&&(j.Kii.logger("And manager: "),j.Kii.logger(b._getManager(a)),b._getManager(a)&&(b._getManager(a)._logIn(c,d),e=!0)),j.Kii.logger("Callbacks"),j.Kii.logger(d),e||null==d?void 0:d.failure(j.KiiUser.getCurrentUser(),a,"Unable to get network. Please ensure the network name is one of the supported KiiSocialNetworkName values")},a.linkCurrentUserWithNetwork=function(a,c,d){var e;return j.Kii.logger("Trying with instance"),j.Kii.logger(b),e=!1,null!=b&&(j.Kii.logger("And manager: "),j.Kii.logger(b._getManager(a)),b._getManager(a)&&(b._getManager(a)._linkWithCurrentUser(c,d),e=!0)),j.Kii.logger("Callbacks"),j.Kii.logger(d),e||null==d?void 0:d.failure(j.KiiUser.getCurrentUser(),a,"Unable to get network. Please ensure the network name is one of the supported KiiSocialNetworkName values")},a.unLinkCurrentUserFromNetwork=function(a,c){if(j.Kii.logger("Trying with instance"),j.Kii.logger(b),null!=b){if(j.Kii.logger("And manager: "),j.Kii.logger(b._getManager(a)),b._getManager(a))return b._getManager(a)._unlinkFromCurrentUser(c)}else if(null!=c)return c.failure(j.KiiUser.getCurrentUser(),a,"Unable to get network. Please ensure the network name is one of the supported KiiSocialNetworkName values")},a.getAccessTokenForNetwork=function(a){return b._getManager(a)._getToken()},a.getAccessTokenExpirationForNetwork=function(a){return b._getManager(a)._getTokenExpiration()},a.getAccessTokenObjectForNetwork=function(a){return b._getManager(a)._getTokenObject()},a.logOutAll=function(){var a,c;return null!=b&&(a=b._getManager(j.KiiSocialNetworkName.FACEBOOK),null!=a&&a._logOut(),c=b._getManager(j.KiiSocialNetworkName.TWITTER),null!=c)?c._logOut():void 0},a}(),l=function(){function a(){this._getManager=m(this._getManager,this)}var b,c;return b=null,c=null,a.prototype._getManager=function(a){return a===j.KiiSocialNetworkName.FACEBOOK?null!=this._facebookManager?this._facebookManager:this._facebookManager=new j.KiiSCNFacebook:a===j.KiiSocialNetworkName.TWITTER?null!=this._twitterManager?this._twitterManager:this._twitterManager=new j.KiiSCNTwitter:void 0},a}(),j.KiiSocialConnectNetwork=function(){function a(a){this._network=a,this._setup=m(this._setup,this),this._unlinkFromCurrentUser=m(this._unlinkFromCurrentUser,this),this._linkWithCurrentUser=m(this._linkWithCurrentUser,this),this._logOut=m(this._logOut,this),this._logIn=m(this._logIn,this),this._reset=m(this._reset,this),this._isAuthenticated=m(this._isAuthenticated,this),this._getCallbacks=m(this._getCallbacks,this),this._setCallbacks=m(this._setCallbacks,this),this._getTokenObject=m(this._getTokenObject,this),this._setTokenObject=m(this._setTokenObject,this),this._getTokenExpiration=m(this._getTokenExpiration,this),this._setTokenExpiration=m(this._setTokenExpiration,this),this._getToken=m(this._getToken,this),this._setToken=m(this._setToken,this),this._getExtras=m(this._getExtras,this),this._setExtras=m(this._setExtras,this),this._getSecret=m(this._getSecret,this),this._setSecret=m(this._setSecret,this),this._getKey=m(this._getKey,this),this._setKey=m(this._setKey,this),this._getNetwork=m(this._getNetwork,this),this._setNetwork=m(this._setNetwork,this)}var b,c,d,e,f,g,h,i;return a.prototype._className="KiiSocialConnectNetwork",e=null,d=null,f=null,c=null,g=null,h=null,i=null,b=null,a.prototype._setNetwork=function(a){this._network=a},a.prototype._getNetwork=function(){return this._network},a.prototype._setKey=function(a){this._key=a},a.prototype._getKey=function(){return this._key},a.prototype._setSecret=function(a){this._secret=a},a.prototype._getSecret=function(){return this._secret},a.prototype._setExtras=function(a){this._extras=a},a.prototype._getExtras=function(){return this._extras},a.prototype._setToken=function(a){this._token=a},a.prototype._getToken=function(){return this._token},a.prototype._setTokenExpiration=function(a){this._tokenExpiration=a},a.prototype._getTokenExpiration=function(){return this._tokenExpiration},a.prototype._setTokenObject=function(a){this._tokenObject=a},a.prototype._getTokenObject=function(){return this._tokenObject},a.prototype._setCallbacks=function(a){this._callbacks=a},a.prototype._getCallbacks=function(){return this._callbacks},a.prototype._isAuthenticated=function(){return null!=this._tokenObject},a.prototype._reset=function(){return this._token=null,this._tokenExpiration=null,this._tokenObject=null,this._key=null,this._secret=null,this._extras=null},a.prototype._logIn=function(a,b){this._callbacks=b},a.prototype._logOut=function(){return this._token=null,this._tokenExpiration=null,this._tokenObject=null},a.prototype._linkWithCurrentUser=function(a,b){this._callbacks=b},a.prototype._unlinkFromCurrentUser=function(a){this._callbacks=a},a.prototype._setup=function(a,b,c){this._key=a,this._secret=b,this._extras=c},a}(),j.KiiSCNFacebook=function(a){function b(){this._unlinkFromCurrentUser=m(this._unlinkFromCurrentUser,this),this._linkWithCurrentUser=m(this._linkWithCurrentUser,this),this._logOut=m(this._logOut,this),this._logIn=m(this._logIn,this),this._unlink=m(this._unlink,this),this._link=m(this._link,this),this._register=m(this._register,this),this._setup=m(this._setup,this),b.__super__.constructor.call(this,KiiSocialNetworkName.FACEBOOK)}var d;return o(b,a),d=null,b.prototype._setup=function(a,c,d){return this._key=a,this._secret=c,this._extras=d,b.__super__._setup.call(this,this._key,this._secret,this._extras),this._extras.appId=this._key,j.Kii.logger(this._extras),FB.init(this._extras)},b.prototype._register=function(a,b){var d,e,f;return f=this,e=new c("/integration/facebook",!0),e.setMethod("POST"),e.setData({accessToken:a}),e.setAnonymous(!0),e.setContentType("application/vnd.kii.AuthTokenFacebookRequest+json"),d={success:function(c){return function(d){var e,f;return c._setToken(a),c._setTokenExpiration(b),e={access_token:a,expires_in:b},c._setTokenObject(e),f=new j.KiiUser,f._updateWithJSON(d),f._setAccessToken(d.access_token),j.Kii.setCurrentUser(f),null!=c._callbacks?c._callbacks.success(j.KiiUser.getCurrentUser(),c._network):void 0}}(this),failure:function(a){return function(b){return null!=a._callbacks?a._callbacks.failure(null,a._network,b):void 0}}(this)},e.execute(d,!1)},b.prototype._link=function(a,b){var d,e,f;return f=this,e=new c("/users/me/facebook/link",!0),e.setMethod("POST"),e.setData({accessToken:a}),d={success:function(c){return function(){var d;return c._setToken(a),c._setTokenExpiration(b),d={access_token:a,expires_in:b},c._setTokenObject(d),null!=c._callbacks?c._callbacks.success(j.KiiUser.getCurrentUser(),c._network):void 0}}(this),failure:function(a){return function(b){return null!=a._callbacks?a._callbacks.failure(j.KiiUser.getCurrentUser(),a._network,b):void 0}}(this)},e.execute(d,!0)},b.prototype._unlink=function(){var a,b,d;return d=this,a=new c("/users/me/facebook/unlink",!0),a.setMethod("POST"),b={success:function(a){return function(){return a._setToken(null),a._setTokenExpiration(null),a._setTokenObject(null),null!=a._callbacks?a._callbacks.success(j.KiiUser.getCurrentUser(),a._network):void 0}}(this),failure:function(a){return function(b){return null!=a._callbacks?a._callbacks.failure(j.KiiUser.getCurrentUser(),a._network,b):void 0}}(this)},a.execute(b,!0)},b.prototype._logIn=function(a,c){var d,e,f,g;return b.__super__._logIn.call(this,a,c),j.Kii.logger("should auth fb"),g=this,j.Kii.logger("Checking options"),j.Kii.logger(a),d=function(a){return function(b){return null!=b.authResponse?(null!=j.KiiUser.getCurrentUser()&&KiiUser.logOut(),a._register(b.authResponse.accessToken,b.authResponse.expiresIn)):null!=a._callbacks?a._callbacks.failure(null,a._network,"User cancelled login or did not fully authorize"):void 0}}(this),null!=a&&null!=a.access_token?(j.Kii.logger("Have options: "),j.Kii.logger(a),null!=j.KiiUser.getCurrentUser()&&KiiUser.logOut(),g._register(a.access_token,null)):(e=null,null!=a&&null!=a.scope&&(e={scope:a.scope}),f=function(a){return"connected"===a.status?d(a):FB.login(d,e)},FB.getLoginStatus(f),f=function(a){return"connected"===a.status?d(a):FB.login(d)},FB.getLoginStatus(f))},b.prototype._logOut=function(){return b.__super__._logOut.apply(this,arguments),j.Kii.logger("Log out fb")},b.prototype._linkWithCurrentUser=function(a,c){var d,e,f,g;return b.__super__._linkWithCurrentUser.call(this,a,c),g=this,d=function(a){return a.authResponse?g._link(a.authResponse.accessToken,a.authResponse.expiresIn):null!=g._callbacks?g._callbacks.failure(null,g._network,"User cancelled Facebook login or did not fully authorize"):void 0},null!=j.KiiUser.getCurrentUser()?null!=a&&null!=a.access_token?g._link(a.access_token,null):(e=null,null!=a&&null!=a.scope&&(e={scope:a.scope}),f=function(a){return"connected"===a.status?d(a):FB.login(d,e)},FB.getLoginStatus(f)):null!=c?c.failure("A KiiUser must be logged in before linking to Facebook"):void 0},b.prototype._unlinkFromCurrentUser=function(a){return b.__super__._unlinkFromCurrentUser.call(this,a),null!=j.KiiUser.getCurrentUser()?this._unlink():null!=a?a.failure("A KiiUser must be logged in before unlinking from Facebook"):void 0},b}(j.KiiSocialConnectNetwork),j.InvalidDisplayNameException=function(){return this.message="Unable to set displayName. Must be between 4-50 characters."},j.InvalidPasswordException=function(){return this.message="Unable to set password. Must be between 4-50 characters composed with ascii (exclude control character)"},j.InvalidUsernameException=function(){return this.message="Unable to set username. Must be between 3 and 64 characters, which can include alphanumeric characters as well as underscores '_' and periods '.'"},j.InvalidUserIdentifierException=function(){return this.message="User identifier should be one of user name, phone number or email"},j.InvalidEmailException=function(){return this.message="Unable to set email address. Must be a valid email"},j.InvalidPhoneNumberException=function(){return this.message="Unable to set phone number. Must begin with a '+' and be at least 10 digits"},j.InvalidLocalPhoneNumberException=function(){return this.message="Unable to set phone number. Must be a sequence of numbers"},j.InvalidCountryException=function(){return this.message="Unable to set country code. Must be 2 alphabetic characters. Ex: US, JP, CN"},j.InvalidURIException=function(){return this.message="Unable to set URI. Must be of the form kiicloud://some/path/to/object/or/entity"},j.InvalidACLAction=function(){return this.message="Unable to set ACL action. Must be one of the permitted values in KiiACLAction"},j.InvalidACLSubject=function(){return this.message="Unable to set ACL subject. Must be of type KiiUser or KiiGroup"},j.InvalidACLGrant=function(){return this.message="Unable to set ACL grant. Must be a boolean type"},j.InvalidLimitException=function(){return this.message="Unable to set query limit. Must be an integer > 0"},j.InvalidArgumentException=function(a){return this.message="InvalidArgument: "+a},j.KiiAppAdminContext=function(){function a(a){this._getToken=m(this._getToken,this),this._getId=m(this._getId,this),this._objectWithURI=m(this._objectWithURI,this),this._token=a.token,this._id=a.id}var b,c;return c=null,b=null,a.prototype.bucketWithName=function(a){var b;return b=new j.KiiBucketAdmin(a,null,this._token)},a.prototype.groupWithName=function(a){var b;return b=j.KiiGroupAdmin._groupWithName(a,this)},a.prototype.userWithID=function(a){var b;return b=j.KiiUserAdmin._userWithID(a,this)},a.prototype.objectWithURI=function(a){var b;return b=this._objectWithURI(a)},a.prototype._userWithLoginName=function(a,b){var c,d,e;return e=new j.KiiUserAdmin(this),d=e._getRequest({path:"/users/LOGIN_NAME:"+a,withApp:!0}),d.setAdminToken(this._token),c={success:function(){return function(a,c){if(300>c&&c>=200){if(e._updateWithJSON(a),null!=b)return b.success(e)}else if(null!=b)return b.failure("Unable to parse response")}}(this),failure:function(){return function(a){return null!=b?b.failure(a):void 0}}(this)},d.execute(c,!1)},a.prototype._objectWithURI=function(a){var b,c,d,e,f,g,h,i,k,l,m;if(!a)throw new j.InvalidURIException;if(m=0===a.indexOf("kiicloud://"),h=a.substr("kiicloud://".length),f=h.split("/"),e=f.length,!(e>=4&&m))throw new j.InvalidURIException;if(c=4===e?1:3,d=f[c],"groups"===f[0]&&6===e)g=new j.KiiGroupAdmin._groupWithID(f[1],this._token);else if("users"===f[0]&&6===e)l=j.KiiUserAdmin._userWithID(f[1],this._token);else if(4!==e)throw new j.InvalidURIException;return k=null,null!=g?k=g:null!=l&&(k=l),b=new j.KiiBucketAdmin(d,k,this._token),i=b.createObject(),i._setUUID(f[e-1]),i},a.prototype._getId=function(){return this._id},a.prototype._getToken=function(){return this._token},a}(),j.KiiACLAdmin=function(a){function b(a,c){this._userWithID=m(this._userWithID,this),this._groupWithID=m(this._groupWithID,this),this._getRequest=m(this._getRequest,this),b.__super__.constructor.call(this),this._setParent(a),this._adminToken=c}var c;return o(b,a),c=null,b.prototype._getRequest=function(a){var c;return c=b.__super__._getRequest.call(this,a),c.setAdminToken(this._adminToken),c},b.prototype._groupWithID=function(a){var b;return b=j.KiiGroupAdmin._groupWithID(a,this._adminToken)},b.prototype._userWithID=function(a){var b;return b=j.KiiUserAdmin._userWithID(a,this._adminToken)},b}(j.KiiACL),j.KiiGroupAdmin=function(a){function b(a){this._setOwnerFromContext=m(this._setOwnerFromContext,this),this._userWithID=m(this._userWithID,this),this.bucketWithName=m(this.bucketWithName,this),this._getRequest=m(this._getRequest,this),b.__super__.constructor.call(this),this._adminContext=a}var c;return o(b,a),c=null,b.prototype._getRequest=function(a){var c;return c=b.__super__._getRequest.call(this,a),c.setAdminToken(this._adminContext._getToken()),c},b._groupWithName=function(a,b){return j.KiiGroupAdmin._groupWithNameAndMembers(a,null,b)},b._groupWithNameAndMembers=function(a,b,c){var d;return d=new j.KiiGroupAdmin(c),d._setName(a),d._setAddMembers(b),d},b._groupWithID=function(a,b){var c;return c=new j.KiiGroupAdmin(b),c._setUUID(a),c},b.prototype.bucketWithName=function(a){var b;return b=new j.KiiBucketAdmin(a,this,this._adminContext._getToken())},b.prototype._userWithID=function(a){var b;return b=j.KiiUserAdmin._userWithID(a,this._adminContext._getToken())},b.prototype._setOwnerFromContext=function(){},b}(j.KiiGroup),j.KiiObjectAdmin=function(a){function b(a){this._userWithID=m(this._userWithID,this),this.objectACL=m(this.objectACL,this),this._getRequest=m(this._getRequest,this),b.__super__.constructor.call(this),this._adminToken=a}var c;return o(b,a),c=null,b.prototype._getRequest=function(a){var c;return j.Kii.logger("admin req: "+this._adminToken),c=b.__super__._getRequest.call(this,a),c.setAdminToken(this._adminToken),c},b.objectWithBucket=function(a,b,c){var d;return j.Kii.logger("Creating object w type: "+b),d=new j.KiiObjectAdmin(c),d._setBucket(a),d._setObjectType(b),j.Kii.logger(d),d},b.prototype.objectACL=function(){var a;return a=new j.KiiACLAdmin(this,this._adminToken)},b.prototype._userWithID=function(a){var b;return b=j.KiiUserAdmin._userWithID(a,this._adminToken)},b}(j.KiiObject),j.KiiUserAdmin=function(a){function b(a){this.bucketWithName=m(this.bucketWithName,this),this._getRequest=m(this._getRequest,this),b.__super__.constructor.call(this),this._adminContext=a}var c;return o(b,a),c=null,b._userWithID=function(a,b){var c;return c=new j.KiiUserAdmin(b),c._setUUID(a),c},b.prototype._getRequest=function(a){var c;return c=b.__super__._getRequest.call(this,a),c.setAdminToken(this._adminContext._getToken()),c},b.prototype.bucketWithName=function(a){var b;return b=new j.KiiBucketAdmin(a,this,this._adminContext._getToken())},b}(j.KiiUser),j.KiiAnonymousUser=function(){function a(){}return a}(),j.KiiAnyAuthenticatedUser=function(){function a(){}return a}(),j.KiiSDKClientInfo=function(){function a(){}var b;return b=null,a.getSDKClientInfo=function(){return null==a._clientInfo&&(a._clientInfo="sn=jss;sv="+j.Kii.getSDKVersion()),a._clientInfo},a}(),j.KiiSCNTwitter=function(a){function b(){this._unlinkFromCurrentUser=m(this._unlinkFromCurrentUser,this),this._linkWithCurrentUser=m(this._linkWithCurrentUser,this),this._logOut=m(this._logOut,this),this._logIn=m(this._logIn,this),this._unlink=m(this._unlink,this),this._link=m(this._link,this),this._register=m(this._register,this),this._setup=m(this._setup,this),b.__super__.constructor.call(this,KiiSocialNetworkName.TWITTER)}return o(b,a),b.prototype._setup=function(a,c,d){return this._key=a,this._secret=c,this._extras=d,b.__super__._setup.call(this,this._key,this._secret,this._extras)},b.prototype._register=function(a,b){var d,e,f,g;return g=this,f=new c("/integration/twitter",!0),f.setMethod("POST"),d={accessToken:a.oauth_token,accessTokenSecret:a.oauth_token_secret},f.setData(d),f.setAnonymous(!0),f.setContentType("application/vnd.kii.AuthTokenTwitterRequest+json"),e={success:function(c){return function(d){var e,f;return c._setToken(a.oauth_token),e={oauth_token:a.oauth_token,oauth_token_secret:a.oauth_token_secret},c._setTokenObject(e),f=new j.KiiUser,f._updateWithJSON(d),f._setAccessToken(d.access_token),j.Kii.setCurrentUser(f),null!=b?b.success(j.KiiUser.getCurrentUser(),c._network):void 0}}(this),failure:function(a){return function(c){return null!=b?b.failure(null,a._network,c):void 0}}(this)},f.execute(e,!1)},b.prototype._link=function(a,b){var d,e,f,g;return g=this,f=new c("/users/me/twitter/link",!0),f.setMethod("POST"),d={accessToken:a.oauth_token,accessTokenSecret:a.oauth_token_secret},f.setData(d),e={success:function(c){return function(){var d;return c._setToken(a.oauth_token),d={oauth_token:a.oauth_token,oauth_token_secret:a.oauth_token_secret},c._setTokenObject(d),null!=b?b.success(j.KiiUser.getCurrentUser(),c._network):void 0}}(this),failure:function(a){return function(c){return null!=b?b.failure(j.KiiUser.getCurrentUser(),a._network,c):void 0}}(this)},f.execute(e,!0)},b.prototype._unlink=function(a){var b,d,e;return e=this,b=new c("/users/me/twitter/unlink",!0),b.setMethod("POST"),d={success:function(b){return function(){return b._setToken(null),b._setTokenObject(null),null!=a?a.success(j.KiiUser.getCurrentUser(),b._network):void 0}}(this),failure:function(b){return function(c){return null!=a?a.failure(j.KiiUser.getCurrentUser(),b._network,c):void 0}}(this)},b.execute(d,!0)},b.prototype._logIn=function(a,c){var d;if(b.__super__._logIn.call(this,a,c),d=this,j.Kii.logger("Checking options"),j.Kii.logger(a),null==a||!a.oauth_token&&!a.oauth_token_secret)throw j.InvalidArgumentException("Both options.oauth_token and options.oauth_token_secret are required");if(!a.oauth_token)throw j.InvalidArgumentException("options.oauth_token is required");if(!a.oauth_token_secret)throw j.InvalidArgumentException("options.oauth_token_secret is required");return null!=j.KiiUser.getCurrentUser()&&j.KiiUser.logOut(),d._register(a,c)},b.prototype._logOut=function(){return b.__super__._logOut.apply(this,arguments),j.Kii.logger("Log out twitter")},b.prototype._linkWithCurrentUser=function(a,b){var c;if(c=this,null==j.KiiUser.getCurrentUser())return void b.failure(null,c._network,"No user logged in");if(null==a||!a.oauth_token&&!a.oauth_token_secret)throw j.InvalidArgumentException("Both options.oauth_token and options.oauth_token_secret are required");if(!a.oauth_token)throw j.InvalidArgumentException("options.oauth_token is required");if(!a.oauth_token_secret)throw j.InvalidArgumentException("options.oauth_token_secret is required");return c._link(a,b)},b.prototype._unlinkFromCurrentUser=function(a){var b;return b=this,null==j.KiiUser.getCurrentUser()?void a.failure(null,b._network,"No user logged in"):this._unlink(a)},b}(j.KiiSocialConnectNetwork),j.KiiGeoPoint=function(){function a(a,b){var c;if(this._latitude=a,this._longitude=b,this._toDict=m(this._toDict,this),this.getLongitude=m(this.getLongitude,this),this.getLatitude=m(this.getLatitude,this),c=function(a,b,c){return c>a&&b>c&&!isNaN(c)},!c(-90,90,a)||!c(-180,180,b))throw j.InvalidArgumentException("Specified latitide or longitude is invalid")}return a.prototype.getLatitude=function(){return this._latitude},a.prototype.getLongitude=function(){return this._longitude},a.geoPoint=function(a,b){return new j.KiiGeoPoint(a,b)},a.prototype._toDict=function(){var a;return a={_type:"point",lat:this._latitude,lon:this._longitude}},a}(),b=function(){function a(a,b,c){this.xhr=$.ajaxSettings.xhr(),this.xhr.open(a,b,!0),this.xhr.onreadystatechange=c.onComplete}return a.xhr=null,a}(),i=function(){function a(a,b,c){this.xhr=new XMLHttpRequest,"withCredentials"in this.xhr?(this.xhr.open(a,b,!0),this.xhr.onreadystatechange=c.onComplete):this.xhr=null}return a.xhr=null,a}(),e=function(){function a(a,b,c){this.xhr=Ti.Network.createHTTPClient(),this.xhr.open(a,b,!0),this.xhr.onload=c.onComplete,this.xhr.onerror=c.onError}return a.xhr=null,a}(),h=function(){function b(){}return b.createXHRWrapper=function(b,c){var e;return e=null,null===j.Kii._getHttpRequestType()?"undefined"!=typeof jQuery?(j.Kii.logger("Use jQuery"),e=new a(b,c)):"undefined"!=typeof XMLHttpRequest?(j.Kii.logger("Use XMLHttpRequest"),e=new g(b,c)):"undefined"!=typeof Titanium&&(j.Kii.logger("Use Titanium"),e=new d(b,c)):(j.Kii.logger("Use http request backdoor"),j.Kii._getHttpRequestType()===j._KiiHttpRequestType.jQuery?(j.Kii.logger("Use jQuery"),e=new a(b,c)):j.Kii._getHttpRequestType()===j._KiiHttpRequestType.XMLHttpRequest?(j.Kii.logger("Use XMLHttpRequest"),e=new g(b,c)):j.Kii._getHttpRequestType()===j._KiiHttpRequestType.Titanium&&(j.Kii.logger("Use Titanium"),e=new d(b,c))),e},b}(),g=function(){function a(a,b){this.sendData=m(this.sendData,this),this.send=m(this.send,this),this._setUpCallbacks=m(this._setUpCallbacks,this),this.xhr=new XMLHttpRequest,this.method=a,"withCredentials"in this.xhr?this.xhr.open(a,b,!0):this.xhr=null}return a.xhr=null,a.method=null,a.prototype._setUpCallbacks=function(a){return a&&a.progress?"PUT"===this.method?this.xhr.upload.addEventListener("progress",a.progress,!1):this.xhr.addEventListener("progress",a.progress,!1):void 0},a.prototype.send=function(a){var b;return this._setUpCallbacks(a),b={onComplete:function(b){return function(){var c;if(4===b.xhr.readyState)if(200<=(c=b.xhr.status)&&400>c){if(j.Kii.logger("Completed Request["+b.xhr.status+"]"),null!=a)return a.success()}else if(j.Kii.logger("Error loading data..."),j.Kii.logger("callback : "+a),null!=a)return a.failure()}}(this)},this.xhr.onreadystatechange=b.onComplete,this.xhr.send()},a.prototype.sendData=function(a,b){var c;return this._setUpCallbacks(b),c={onComplete:function(a){return function(){var c;if(4===a.xhr.readyState)if(200<=(c=a.xhr.status)&&400>c){if(j.Kii.logger("Completed Request["+a.xhr.status+"]"),null!=b)return b.success()}else if(j.Kii.logger("Error loading data..."),null!=b)return b.failure()}}(this)},this.xhr.onreadystatechange=c.onComplete,this.xhr.send(a)},a}(),d=function(a){function b(a,b){this.sendData=m(this.sendData,this),this.send=m(this.send,this),this.xhr=Ti.Network.createHTTPClient(),this.method=a,this.xhr.open(a,b,!0)}return o(b,a),b.prototype.send=function(a){var b;return this._setUpCallbacks(a),b={onComplete:function(b){return function(){var c;if(4===b.xhr.readyState)if(200<=(c=b.xhr.status)&&400>c){if(j.Kii.logger("Completed Request["+b.xhr.status+"]"),null!=a)return a.success()}else if(j.Kii.logger("Error loading data..."),j.Kii.logger("callback : "+a),null!=a)return a.failure()}}(this),onError:function(){return function(){return j.Kii.logger("Error loading data..."),j.Kii.logger("callback : "+a),null!=a?a.failure():void 0}}(this)},this.xhr.onload=b.onComplete,this.xhr.onerror=b.onError,this.xhr.send()},b.prototype.sendData=function(a,b){var c;return this._setUpCallbacks(b),c={onComplete:function(a){return function(){var c;if(4===a.xhr.readyState)if(200<=(c=a.xhr.status)&&400>c){if(j.Kii.logger("Completed Request["+a.xhr.status+"]"),null!=b)return b.success()}else if(j.Kii.logger("Error loading data..."),null!=b)return b.failure()}}(this),onError:function(){return function(){return j.Kii.logger("Error loading data..."),j.Kii.logger("callback : "+b),null!=b?b.failure():void 0}}(this)},this.xhr.onload=c.onComplete,this.xhr.onerror=c.onError,this.xhr.send(a)},b}(g),a=function(a){function b(a,b){this.xhr=$.ajaxSettings.xhr(),this.xhr.open(a,b,!0),this.method=a}return o(b,a),b}(g),j};!function(){var b="undefined"!=typeof module&&null!==module;b&&module.exports?module.exports={create:function(){return a.call(this)}}:a()}()}(),angular.module("akaPenSenseiApp",["ngCookies","ngResource","ngSanitize","ngRoute","ui.bootstrap","angularFileUpload"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).when("/page",{templateUrl:"views/page.html",controller:"PageCtrl"}).when("/upload",{templateUrl:"views/upload.html",controller:"UploadCtrl"}).otherwise({redirectTo:"/"})}]),angular.module("akaPenSenseiApp").controller("MainCtrl",["$scope","DbService","TargetContent",function(a,b,c){a.contents=[{src:"https://avatars3.githubusercontent.com/u/1072879?s=140"}],b.getAllContentList().then(null,null,function(b){a.contents.push(b)}),a.setContent=function(a){c.src=a.src,c.id=a.id}}]),angular.module("akaPenSenseiApp").directive("drawing",function(){return{restrict:"A",link:function(a,b){function c(){b[0].width=b[0].width}function d(){return b[0].toDataURL("image/png")}function e(a,b,c,d){h.moveTo(a,b),h.lineTo(c,d),h.strokeStyle="red",h.stroke()}var f,g,h=b[0].getContext("2d"),i=!1;b.bind("mousedown",function(a){f=a.offsetX,g=a.offsetY,h.beginPath(),i=!0});var j,k;b.bind("mousemove",function(a){i&&(j=a.offsetX,k=a.offsetY,e(f,g,j,k),f=j,g=k)}),b.bind("mouseup",function(){i=!1}),a.reset=c,a.getDataURL=d}}}),angular.module("akaPenSenseiApp").controller("PageCtrl",["$scope","DbService","TargetContent",function(a,b,c){function d(){return a.getDataURL()}a.totalItems=64,a.currentPage=1,a.comment="",a.pageChanged=function(){console.log(a.totalItems,a.currentPage)},a.src=c.src,a.save=function(){var e={contentId:c.id,akapen:d(),comment:a.comment};console.log(e),b.saveAkapenData(e)},a.akapenList=[],b.getAkapenDataList(c.id).then(null,null,function(b){a.akapenList.push(b)})}]),angular.module("akaPenSenseiApp").controller("UploadCtrl",["$scope","DbService",function(a,b){a.title="",a.description="";var c=null;a.uploadedImageUrl="",a.upload=function(){b.upload(c,a.title,a.description,function(b){a.$apply(function(){a.uploadedImageUrl=b})})},a.onFileSelect=function(a){c=a[0],console.log(a)}}]),angular.module("akaPenSenseiApp").service("DbService",["$q",function(a){function b(){var b=a.defer();if(f.user)b.resolve(f.user);else{var c="test",d="test";KiiUser.authenticate(c,d,{success:function(a){console.log("User authenticated!"),console.log(a),f.user=a,b.resolve(a)},failure:function(a,c){console.log("Error authenticating: "+c),b.reject()}})}return b.promise}function c(){var c=a.defer();return b().then(function(a){c.resolve(a.bucketWithName("image"))}),c.promise}function d(){var c=a.defer();return b().then(function(a){c.resolve(a.bucketWithName("akapen"))}),c.promise}function e(a,b){var c=a.objectURI();a.publishBody({success:function(a,d){var e={src:d,id:c};console.log("URL = ",d),console.log("title = ",c),b.notify(e)},failure:function(a,b){console.log("publish failed.",b)}})}var f=this;Kii.initializeWithSite("966eb9b6","e0e4c26eb09772eb1f591f063162b3dd",KiiSite.JP),this.getAllContentList=function(){var b=a.defer();return c().then(function(a){var c={success:function(d,f,g){for(var h=0;h<f.length;h++)e(f[h],b);null!=g&&a.executeQuery(g,c)},failure:function(a,b){console.log("error query",a,b)}};a.executeQuery(null,c)}),b.promise},this.upload=function(a,b,d,e){c().then(function(c){var f=c.createObject();f.set("title",b),f.set("description",d),f.save({success:function(b){console.log("Object saved & bucket created!",b),b.uploadBody(a,{progress:function(a){if(a.lengthComputable){var b=a.loaded/a.total;console.log("upload percentComplete: "+b)}},success:function(a){a.publishBody({success:function(a,b){e(b),console.log(b)},failure:function(a,b){console.log("publish failed.",b)}})},failure:function(a,b){console.log(b)}})},failure:function(a,b){console.log("Error saving object and bucket: "+b)}})})},this.saveAkapenData=function(a){d().then(function(b){var c=b.createObject();c.set("contentId",a.contentId),c.set("comment",a.comment),c.set("akapen",a.akapen),c.save({success:function(a){console.log(a)},failure:function(){}})})},this.getAkapenData=function(b){var c=a.defer();return d().then(function(a){var d=KiiClause.equals("contentId",b),e=KiiQuery.queryWithClause(d),f={success:function(d,e,g){for(var h=0;h<e.length;h++){console.log("akapenData get.",e[h]);var i={contentId:b,akapen:e[h].get("akapen"),comment:e[h].get("comment")};c.resolve(i)}null!=g&&a.executeQuery(g,f)},failure:function(){}};a.executeQuery(e,f)}),c.promise},this.getAkapenDataList=function(b){var c=a.defer();return d().then(function(a){var d=KiiClause.equals("contentId",b),e=KiiQuery.queryWithClause(d),f={success:function(d,e,g){for(var h=0;h<e.length;h++){console.log("akapenData get.",e[h],e[h].get("contentId"));var i={contentId:b,akapen:e[h].get("akapen"),comment:e[h].get("comment")};c.notify(i)}null!=g&&a.executeQuery(g,f)},failure:function(){}};a.executeQuery(e,f)}),c.promise}}]),angular.module("akaPenSenseiApp").service("TargetContent",function(){this.id=-1,this.src=""});